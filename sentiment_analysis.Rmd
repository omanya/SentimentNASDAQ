---
title: "'Buy on rumor, sell on news': the effect of news arrivals and investor sentiment on the distribution of excess returns"
author: Maria Osipenko^[Hochschule für Wirtschaft und Recht Berlin; osipenko@hwr-berlin.de], Rui Ren^[Humboldt-Universität zu Berlin]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
  bookdown::pdf_document2:
    toc: false
    fig_caption: yes
    keep_tex: true
bibliography: [packages.bib, references.bib] 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE, include=FALSE}
# usethis::create_from_github(
#   "https://github.com/omanya/SentimentNASDAQ.git",
#   destdir = "C:/Users/osipenko/Downloads/"
# )
#'Buy on rumor, sell on news': distribution of excess returns from the perspective of investor opinion
```


# Abstract {-}

We analyse how the distribution of excess returns is influenced by investor opinion as investor sentiment and news arrivals by applying the expectile regression to a panel of $100$ excess equity returns in NASDAQ over the period April 2015 - August 2019. We break down investor opinion in investor attention, perception and sentiment and use firm and time specific proxies as news arrivals and news sentiment computed by dictionary and machine learning methods for each of the channels. 

We find, that various effects depend on the expectile level $\tau$, which itself can be understood as the 'state of the world' for individual equity returns. While not always significant for the mean regression, the proxies of investment opinion impact the conditional distribution of asset returns which we show empirically. 

When analyzing the effect of news and earnings announcements, we find a positive impact of the day before earnings announcements and a negative impact of news arrivals on low return expectiles. We explain this effect with the strategy "buy on rumor, sell on news" for low return states.

Our expectile regression approach allows us to naturally generalize the previous studies of conditional mean regression to higher conditional moments and estimate investor opinion impact thereon. Moreover, by using the relation of expectiles to expected shortfall, we are able to obtain the effects of investor opinion on the conditional expected shortfall.

```{r,echo=FALSE, include=FALSE}
#citations for the packages
knitr::write_bib(c("knitr", "rmarkdown", "sandwich","kableExtra"), width = 60,file ="packages.bib")
```


# Introduction {-}

The effects of public information flow as news arrivals and investor sentiment on stock returns and the question whether they make up good predictors of the later have captured attention of many researches. However the results are somewhat fragmented and debatable. For instance, @Antweiler2004 find that the number and extent of text messages influences stock volatility but not returns.  @DAS2007 observe that the message volume (regarded as optimistic sentiment) is positively correlated with stock volatility but negatively correlated with stock returns. @HAGENAU2013 and @NGUYEN2015 among others are able to significantly improve their return forecasts by using sentiment from news or social media. @SHANG2014 find a significant effect of sentiment only related to the negative announcements. @KIM2014 find no evidence for predictive power of sentiment neither on returns nor on volatility or trading volume. Recently, @AUDRINO2020 and @FANG2021 again report an improvement in volatility forecasts on using sentiment from news and social media.

@Su2021 distinguish three channels, through which the information flow may influence asset returns: *investor perception* (expectations, risk perception and individual believes), captured by financial variables, event-related *investor attention*  and *investor sentiment* usually specified as polarity of news and social media messages content. 

In this paper we analyse the impact of the three information flow channels on the distribution of daily asset returns. Thereby we indicate *investor attention* using indicators of days around earnings announcements, news arrivals and share turnover.  *Investor perception* is captured by book-to-market ratios, size and earnings surprises. Dictionary-based and machine learning polarity assessment of firm-specific news content measures are used as proxies of *investor sentiment*. Our choice of the proxies is based on the empirical evidence found in the previous literature, which we provide below.

Two important issues arise when analyzing the effects above. First, whereas some of the indicators as earnings announcements and news arrivals can be directly observed, investor sentiment is a latent variable and has to be inferred from news and social media messages. The later holds also for the investor perception channel. Second, although most empirical findings confirm significant effects, there is no consensus on which parameters of the conditional return distribution are affected (conditional expectation, variance or higher moments). 
<!--whether the conditional expectation of return itself or its conditional variance or other distributional features are effected and what is the direction of the effect. -->

To model the impact on the conditional variance, typically GARCH-type models are employed. @CAMPBELL1992 proposes such a model which incorporates an asymmetric news-about-dividends impact on return volatility. Further focusing on this effect and using broad firm specific news arrivals as a proxy for information flow @KALEV2004 report significant effects on intraday and daily level. The authors write "when public news is released, market activity intensifies as a result of belief revisions caused by the divergence of opinions among traders". @Maheu2004 also find empirical evidence for an asymmetric effect of positive and negative news on volatility jumps. The authors infer the positiveness or negativeness using the earnings surprises without any textual analysis of news content. Thereby they assume, that a positive surprise indicates positive news and vice versa. According to our empirical findings, this is not always the case. Specifically, for the lower tail of the conditional return distribution, also positive news can have a negative impact. @Cao2002 argue, that not only second but also third moments of return distribution are effected by information arrival due to inert "sidelined" investors. 

<!--To quantify the effect on the conditional return expectation-->
@ENGELBERG2018 consider return anomalies and find a sign-changing asymmetric effect on information days. The sign depends on  an anomaly-based classification of the respective stock as anomaly-short or anomaly-long. Whereas returns of the later profit from new arrivals, the returns of the anomaly-short stocks fall on news arrival days. Based thereof, the effect of news arrivals may be anticipated by at least some investors and used for developing a trading strategy depending on their believes and the state of the world. This hypothesis is supported also in our empirical results where news arrivals have negative impact on lower tail of the conditional return distribution even if the overall tone of the news is positive.

Rather then concentrating only on the event of news arrivals, many researches attempt to quantify the (thematic) polarity of news. For instance, @Luss2012 use textual features from news articles and support vector machines to predict the magnitude of stock returns. They report a significant improvement in model performance due to text information. More on lexicons and machine learning sentiment. @Su2021 classifies the related approaches as dictionary-based (word lists with positive and negative words) and machine learning based ones. The first one relies on word lists with positive and negative words with the most famous dictionaries - Harvard (HV) and Loughran \& McDonald word lists (e.g. @LOUGHRAN2011, @JEGADEESH2013). The second machine learning approach uses statistical models to map the word content to a relevant variable as return (e.g. @Antweiler2004, @FANG2021).

Further, @BERKMAN2009 argues that varying degree in differences of opinions regarding some stocks may influence their reaction around earnings announcements. Among other proxies for the opinion gap they use share turnover in the time span around earnings announcements. The authors argument that stocks with high degree of opinion differences are overpriced and earn lower return on earnings announcement days due to opinion alignment. Our empirical results suggest that on days around earnings announcements share turnover is exhibits a changing sign effect starting with a negative coefficient for left tail and ending up with a positive impact on the right tail of conditional return distribution.

Investor attention and polarity of news content present only one facet of information flow important for stock pricing. Financial indicators which reflect investor expectations are found to be good return predictors.  @FAMA1992,  @KOTHARI1997  and @PONTIFF1998 point out that book-to-market ratio enhances better predictability of returns as an indicator of future earnings. @Billings2001 find that the lag component in BTM ratio related to past price changes is useful in predicting returns. The authors also discover its strong association with earnings forecasts. In our analysis book-to-market (btm)  ratio reflecting investor expectations builds up an indicator of the investor perception. We also control for the size effect (@FRIEND1988) by including $\log(Size)$ in our analysis as an indicator of investor risk perception.

We incorporate all three mentioned investor opinion channels in our model and conduct a comprehensive analysis of the respective effects. Since there is seemingly no consensus in the previous studies, which conditional moments are affected, we estimate the effects of information flow channels **on the whole distribution** of asset returns braking it down to a fine grid of tail indices. That way we are neither constrained to a particular distributional assumption nor to certain conditional moments of the return distribution. 

A natural choice of such tail indices are quantiles (@Koenker1978) of the return distribution, $q_{\alpha}(r_{i,t})$, for a range of $\alpha$-values in $(0,1)$ capable of representing the whole return distribution without explicit distributional assumtions. By means of quantile regression for a set of $\alpha\in(0,1)$ distributional effects of investor opinions can be estimated. @NI2015, @Ma2018 and @ALNASSERI2021 use quantile regression to address the  distributional effects of sentiment on the return. The authors find different effects for different quantile levels and point out that, overall, extreme markets are driven by investor sentiment.

Instead of using $\alpha$-quantiles for representing the conditional return distribution, an alternative measure $\tau$-expectiles introduced in @Newey1987 can be employed. The $\tau$-expectile is the real number, such that the $\tau$-proportion of the expected distance to it lies below and the $(1-\tau)$-proportion lies above it. As quantiles generalize the concept of the median, expectiles generalize the concept of the mean. Therefore, the expectile regression for a range of $\tau$-values in $(0,1)$ naturally generalizes the mean regression and is capable of capturing the effects on the whole distribution of returns in our case. This fact makes our analysis comparable with the previous findings based on the mean regression for $\tau=0.5$ on one hand and capable of capturing distributional effects for $\tau\in (0,1)\setminus\{0.5\}$ on the other.  

In summary, our expectile regression approach allows to study heterogeneous effects over the whole distribution of returns breaking it down to different expectile levels (similar to quantile regression), but, as opposed to quantile regression, covers the mean regression as a special case of $\tau=0.5$ and facilitates simple and efficient estimation and inference on the obtained parameters (@waltrup2015 on the efficiency of expectles, @Barry2018 for inference).

Using coefficient standard errors robust to serial and cross-sectional correlation, we confirm significant positive effect of the day before earnings announcements and a significant negative effect of news arrivals *on lower tail of return distribution* even if the polarity of the news is positive. Our explanation for the effects connects to a trading strategy "buy on rumor, sell news". That is, some investors tend to buy equities with low returns when they expect their growth (the 'rumor' part)  (when they are believed to be underpriced) and sell low return stocks to ride on the hype of positive news arrivals. 

Further advantage of our expectile-based approach lies in risk management perspective. Well-known connection of expectiles to expected shortfall (@Taylor2008) makes our investigation of the factors impacting th expectiles of the returns potentially useful for risk management insights. Using the estimated effects from our conditional expectile model, we are able to obtain plug-in estimates for the respective effects on the conditional expected shortfall and to evaluate their significance via bootstraping.

The contribution of our paper is as follows. First by incorporating all three investor opinion channels in our model, we  conduct a more extensive (comprehensive) analysis of the respective effects, which makes our approach stand out from the previous related studies. Second, we estimate the effects of information flow channels on the whole distribution of asset returns braking it down to a fine grid of tail indices - expectiles - avoiding any distributional assumptions or model constrains to particular conditional moments. Third, based on the connection of expectile and expected shortfall, we obtain the estimated effects of the investor opinion directly on the expected shortfall for returns distribution, which is highly relevant for risk management and uncovered in the existing studies.

The rest of the paper is organized as follows. First, we introduce our data and the variables we use to proxy the investor opinion. Next, we describe our conditional expectile model and its estimation in detail. Presentation of  the estimation results follows. Then, we describe how plug-in estimates for the effects on expected shortfall can be obtained based on our conditional expectile model, present the resulting estimates and their respective boostrap confidence intervals. Finally, we discuss the implications and limitations of the study.


# Data 

We use data for NASDAQ stocks in the period April 2015 - August 2019 obtained from Bloomberg. Our dependent variable is the excess return of NASDAQ stocks in the mentioned period, computed as...  {\color{red}(How we computed excess returns?)}. The associated data on the size, the btm ratios, the share turnover, and the associated new articles build up the set of explanatory variables.

We combine this data with the records on earnings announcements from https://www.kaggle.com/datasets/tsaustin/us-historical-stock-prices-with-earnings-data (accessed on 21.September 2022) and the sector classification from NASDAQ website (https://www.nasdaq.com/market-activity/stocks/screener, accessed on 10. September 2022).


```{r,echo=FALSE}
rm(list=ls())
set.seed(123)
data<-read.csv("data.csv")
data$Date<-as.POSIXct(data$Date)

#rename ML sentiment
colnames(data)[grepl("RFFin",colnames(data))]<-"ML.TONE"
data$ML_pos<-0; data$ML_pos[data$ML.TONE>0]<-data$ML.TONE[data$ML.TONE>0]
data$ML_neg<-0; data$ML_neg[data$ML.TONE<0]<--data$ML.TONE[data$ML.TONE<0]
data$news<-ifelse(data$word_count>0,1,0)


colnames(data)[grepl("RF12",colnames(data))]<-"ML.TONE12"
colnames(data)[grepl("FinNN",colnames(data))]<-"ML.TONENN"

#scale
cols_scale<-c("LM.TONE","HIV4.TONE","ML.TONE","ML.TONE12","ML.TONENN")
scale01<-function(x){
  xx<-x
  xx[x>0]<-x[x>0]/(abs(max(x,na.rm=T)))
  xx[x<=0]<-x[x<=0]/(abs(min(x,na.rm=T)))
  return(xx)
}
data[,cols_scale]<-apply(data[,cols_scale],2,scale01)

#substitute negative btms
data$BTM[data$BTM<0]<-0

```


<!--Compute lagged/one-step ahead variables:-->

```{r, echo=FALSE}
Ticker<-unique(data$Ticker)
ret1<-numeric(nrow(data))
btm1<-turnover1<-numeric(nrow(data))
news1<-news2<-news3<-news4<-news5<-numeric(nrow(data))
lm.tone1<-hv.tone1<-ml.tone1<-numeric(nrow(data))
for(i in 1:length(Ticker)){
  ind<-which(data$Ticker==Ticker[i])
  ret1[ind]<-c(NA,data$r_.ab.[ind[-length(ind)]]) #lag of return
  btm1[ind]<-c(NA,data$BTM[ind[-length(ind)]]) #lag of btm
  turnover1[ind]<-c(NA,data$TURNOVER[ind[-length(ind)]]) #lag of turnover
  lm.tone1[ind]<-c(NA,data$LM.TONE[ind[-length(ind)]]) #lag of lm
  hv.tone1[ind]<-c(NA,data$HIV4.TONE[ind[-length(ind)]]) #lag of hv
  ml.tone1[ind]<-c(NA,data$ML.TONE[ind[-length(ind)]]) #lag of lm
  #lags of 
  #news arrivals
  news1[ind]<-c(NA,data$news[ind[-length(ind)]])
  news2[ind]<-c(NA,news1[ind[-length(ind)]]) 
  news3[ind]<-c(NA,news2[ind[-length(ind)]]) 
  news4[ind]<-c(NA,news3[ind[-length(ind)]]) 
  news5[ind]<-c(NA,news4[ind[-length(ind)]]) 
}

data$ret1=ret1
data$btm1<-btm1
data$turnover1<-turnover1
data$news1<-news1;  data$news2<-news2; data$news3<-news3; data$news4<-news4;  data$news5<-news5

data$lm.tone1<-lm.tone1; data$hv.tone1<-hv.tone1; data$ml.tone1<-ml.tone1


rm(btm1)
rm(ret1)
```

(assumption: the intraday returns do not influence news articles of the same day)


```{r,echo=FALSE}
#combine with earnings announcements
ean<-read.csv("./stocks_latest/earnings_latest.csv")
ean$ean<-1 # indicator of rearnings
ean$eps<-as.numeric(ean$eps); ean$eps_est<-as.numeric(ean$eps_est)
compute_surprise<-function(eps,eps_est){
  out<-eps
  out[!is.na(eps_est)&eps_est!=0]<-(eps[!is.na(eps_est)&eps_est!=0]-eps_est[!is.na(eps_est)&eps_est!=0])/eps_est[!is.na(eps_est)&eps_est!=0]
  return(out)
}
ean<-transform(ean,surprise=compute_surprise(eps,eps_est))
ean$surprise[is.na(ean$surprise)]<-0
ean$surprise<-scale01(ean$surprise)
data<-merge(data,ean[,c("symbol", "date","ean","surprise") ], by.x=c("Date","Ticker"),by.y=c("date","symbol"),all.x=T)

data$surprise[is.na(data$ean)]<-0
data$ean[is.na(data$ean)]<-0

#days around th earnings announcements
data<-transform(data, days_ean=NA, pre_ean=0, post_ean=0)
data = data[order(data$Ticker,data$Date),]
tickers<-unique(data$Ticker)
for( i in 1: length(tickers)){
  ticker = tickers[i]
  indi = data$Ticker==ticker
  datai = data[indi,]
  datai = datai[order(datai$Date),]
  ind_ean = which(datai$ean==1)
  days_ean = numeric(nrow(datai))
  days_ean[c(ind_ean, ind_ean-1, ind_ean+1)]<-1
  surprise1 = c(NA,datai$surprise[-sum(indi)])
  data$days_ean[indi]<-days_ean
  data$pre_ean[indi][ind_ean-1]<-1
  data$post_ean[indi][ind_ean+1]<-1
  data$surprise1<-surprise1
}

```

```{r,echo=FALSE}
sectors<-read.csv2("nasdaq_screener.csv")
data<-merge(data,sectors[,c("Symbol","Sector")], by.x=c("Ticker"),by.y=c("Symbol"),all.x=T)

```


```{r, echo=FALSE}
source("myfuns.R")
#load("data.RData")
```


Based on the available data and on previous findings in the literature, we construct proxies for the three channels of information flow: investor attention, investor sentiment and investor perception described in the following.

## Proxies for investor attention

As proxies for investor attention particular stocks we employ 

- share turnover of the previous period $turn_{i,t-1}$, 
- indicator of news arrival at $t$ $news_{i,t}$ and earnings announcements $ean_{i,t}$ as well as
- indicators of days before and after earnings announcements, $pre\_ean_{i,t}$ and  $post\_ean_{i,t}$. 

The last two together indicate a three-day period around the earnings announcements as in @BERKMAN2009 and the time of news releases. Share turnover is a known indicator of attention, see e.g. @Loh2010.

## Proxies for investor sentiment

As proxies for investor sentiment we use:

- earnings surprise  $surp_{i,t}$ computed as the difference of analysts forecast and the earnings announced;
- dictionary-based polarity assessment of firm specific news content with Loughran \& McDonald (LM) word list, $lm_{i,t}$;
- dictionary-based polarity assessment of firm specific news content with Harvard (HV) word list, $hv_{i,t}$;
- machine learning assessment of news polarity with FinBert and random forest model. The resulting polarity is then the out-of-sample forecast of the machine learning (ML) model, $ml_{i,t}$. {\color{red}(...Here description of the sentiment extraction)}

We normalize the last three sentiment measures to the interval $[-1,1]$.

Earnings surprises were used by @Maheu2004 to proxy investor sentiment. For dictionary based methods see e.g. @JEGADEESH2013. @FANG2021 successfully uses machine learning methods (random forest) to infer textual sentiment.

## Proxies for investor perception

As proxies for investor perception we use firm specific 

- size and btm ratios as well as 
- the interaction term between small btm ratio and the post earnings announcements day as well as 
- turnover around earnings announcements.
 
According to @FRIEND1988 the well-known size effect reflects a risk effect and enters therefore our proxy for risk perception.

The btm ratios of the previous period, $btm_{i,t-1}$, represents a proxi for performance expectations. Under residual income valuation model @Peasnell1982 connects the value of stocks and the expectation of future abnormal earnings:

\[v_{i,t}= bv_{it} + \sum_{h=1}^\infty \frac1{(1+r)^h}\mathbb E_t(r_{i,t+h}^a)\]

where $v_{i,t}$ is the market value and $bv_{i,t}$ is the book value of  equity $i$, $r_{i,t}^a$ excess returns at $t$ and $r$ is the cost of capital.

\[btm_{i,t} = \frac{bv_{it}}{v_{i,t}}\]

@DONNELLY2014 writes "The intuition is that the prices of growth stocks are much more sensitive to earnings expectations than those of value stocks." and "Accordingly, their prices are more sensitive than value stocks to any earnings surprise regardless of the sign." Therefore, we also include the interaction term between btm ratio $<1$ and post earnings day $(btm_{i,t-1}<1)\cdot post\_ean_{i,t}$ to control for this effect.

According to @BERKMAN2009, the share turnover around earnings announcements can be an indicator of opinion differences and consequently overpriced stocks, which leads to price correction upon information arrival as the authors argue. Therefore, we also control for this effect by including an interaction term between turnover and days earnings announcements indicator $days\_ean_{i,t}$ in our model. The later indicates the announcement date itself, the day before and the day after the earnings announcements as in @BERKMAN2009.

## Empirical data summary

We provide a standard summary of data for each variable in Table \@ref(tab:table01) and Table \@ref(tab:table02), a time period and sector wise expectile summaries of the return distributions in Table \@ref(tab:table03) and Table \@ref(tab:table04), and per-expectile summary of explanatory variables to give the reader an overview of the data structure in Table \@ref(tab:table05).

```{r, echo=FALSE}
vars<-c("r_.ab.","log.SIZE.","BTM","TURNOVER")#"ean","surprise","news","TURNOVER","LM.TONE","HIV4.TONE","ML.TONE")
#summary(data[,vars])

library(moments)
mysummary<-function(x){
  x<-x[!is.na(x)]
  return(c(min(x),max(x),mean(x),sd(x),skewness(x)))#, kurtosis(x)))
}
```

```{r table01, echo=FALSE}
library(knitr)
library(kableExtra)
options(scipen=999)
tab<-apply(data[,vars], 2,mysummary)
rownames(tab)<-c("min","max","mean","sd","skewness")#,"kurtosis")
colnames(tab)<-c("$r_{\\cdot,\\cdot}$","$\\log(size_{\\cdot,\\cdot})$","$btm_{\\cdot,\\cdot}$", "$turn_{\\cdot,\\cdot}$")
caption<-"Summary statistics for the variables: daily firm excess returns $r$, the logarithm of firm size $\\log(size)$, firm btm ratio $btm$, and shares turnover $turn$."

 knitr::kable(tab, align = "llll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )
```


```{r table02,echo=FALSE}
vars_c<-c("surprise","LM.TONE","HIV4.TONE","ML.TONE")
tab<-cbind(apply(data[data$ean>0,vars_c[1],drop=F]*100,2,mysummary),apply(data[data$news>0,vars_c[2:4]],2,mysummary))
rownames(tab)<-c("min","max","mean","sd","skewness")#,"kurtosis")
colnames(tab)<-c("$supr$",  "$lm\\_tone$", "$hv\\_tone$", "$ml\\_tone$")
caption<-"Summary statistics for the variables: earning surprise $supr$ only for the days of earnings announecements, news sentiment based on LM dictionary denoted as $lm\\_tone$, on HV dictionary denoted as $hv\\_tone$, and news sentiment based on machine learning denoted as $ml\\_tone$ only for the days of news releases."

 knitr::kable(tab, align = "llll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )
```
In Table \@ref(tab:table03) empirical return expectiles $\hat e_{\tau}$ for $\tau = 0.05,0.25,0.5,0.75,$ and $0.95$ and different sub periods of the considered time span are reported. We observe that the tail indices remain approximately the same over time.

```{r table03, echo=FALSE}
library(expectreg,quietly =T,verbose=F)
taus=c(0.05,0.25,0.5,0.75,0.95)

expectile_taus<-function(x,taus){
  return(sapply(taus,FUN=expectile,x=x))
}

#expectiles
tab<-rbind(expectile_taus(data$r_.ab.,taus),
           expectile_taus(data$r_.ab[data$Year%in% c("2015","2016")],taus),
           expectile_taus(data$r_.ab[data$Year%in% c("2017", "2018", "2019")],taus)                                       )



rownames(tab)<-c("2015-2019",  "2015-2016", "2017-2019")
colnames(tab)<-paste0("$\\hat e_{",taus,"}$")
caption<-"Empirical expectiles for the excess returns for the whole time span 2015-2019, for the first sub period 2015-2016 and for the second sub period 2017-2019."

 knitr::kable(tab, align = "lll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )
```
In Table \@ref(tab:table04) we report the empirical return expectiles $\hat e_{\tau}$ for $\tau = 0.05,0.25,0.5,0.75,$ and $0.95$ sector wise.



```{r table04, echo=FALSE}

#expectiles
exps<-expectile(data$r_.ab.,probs=taus)

tab<-cbind(aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[1]),
           aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[2])[,2],
aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[3])[,2],
aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[4])[,2],
aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[5])[,2])



colnames(tab)[-1]<-paste0("$\\hat e_{",taus,"}$")
caption<-"Empirical expectiles for the excess returns for the whole time span 2015-2019 for each of the ten sectors"

 knitr::kable(tab, align = "lll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )
```
Here we observe substantial variation of empirical expectiles between sectors. Based on this observation, we include sector and firm dummies to account for the posible individual variability and the variability across sectors.

In the following Table \@ref(tab:table05) per-expectile distributional summary is displayed. The summary statistics for the explanatory variables is conditioned on excess returns belonging to a specific empirical expectile interval: $[\min(r), \hat e_{0.05})$, $[\hat e_{0.05}, \hat e_{0.25} )$,  $[\hat e_{0.25}, \hat e_{0.5})$,  $[\hat e_{0.5}, \hat e_{0.75})$, $[\hat e_{0.75}, \hat e_{0.95})$, and $[\hat e_{0.95}, \max(r)]$. We report the mean and the standard deviation in parenthesis for the variables.

```{r table05,echo=FALSE}

lbls<-c(paste("$r\\leq \\hat e_{",taus[1],"}$"),
        paste("$\\hat e_{",taus[1:(length(taus)-1)],"}\\leq r\\leq \\hat e_{",taus[-1],"}$"),paste("$r\\geq \\hat e_{",taus[length(taus)],"}$"))

data$crab<-cut(data$r_.ab.,breaks=c(-Inf,exps,+Inf),labels=lbls)

mysummary2<-function(x){
  return(paste0(round(mean(x),4)," (",round(sd(x),4),") "))
}


tab<-cbind(aggregate(turnover1~crab,data=data,FUN=mysummary2)[,2],
           aggregate(log.SIZE.~crab,data=data,FUN=mysummary2)[,2],
           aggregate(btm1~crab,data=data,FUN=mysummary2)[,2],
           aggregate(news~crab,data=data,FUN=mysummary2)[,2],
           aggregate(ean~crab,data=data,FUN=mysummary2)[,2]
           )

colnames(tab)<-c("$turn$","$\\log(size)$", "$btm$","$news$", "$ean$")
caption<-"Per-expectile means (standard deviations) of the variables shares turnover $turn$, logarithm of size $\\log(size)$, btm ratios $btm$, indicator of news arrivals $news$, and indicator of earnings announcements $ean$."
rownames(tab)<-lbls

 knitr::kable(tab, align = "lll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )

```
Interestingly, the extreme return states $r\leq \hat e_{0.05}$ and $r\geq \hat e_{0.95}$ are associated with substantially higher mean turnover and earnings announcements rate, slightly lower mean size and with somewhat higher mean btm ratios and news arrivals rate.

```{r, echo=FALSE}
save(data, file="data.RData")
```

Based on the data description above, one expects possibly different effects of the considered covariates on the location, scale and shape of the conditional return distribution. As in the summaries above, it is possible to represent the conditional return distribution through its conditional expectiles. A practical estimator of the heterogeneous effects over the return distribution can be obtained by expectile regression.


# Expectile regression for the panel data of NASDAQ returns

As mentioned in the introduction, conditional expectile extends the associated mean regression and allows to assess the considered effects on the whole distribution of asset returns braking it down to a fine grid of expectiles. That way we are neither constrained to a particular distributional assumption nor to certain conditional moments of the return distribution. In this section we review the general set up of the conditional mean model for the panel data of stock returns and its generalization to conditional expectile regression (ER).

## General model definition

Consider a conditional mean model for the panel data of stock return ($r_{i,t}$) of firm $i$ at time $t$ with $i=1,\ldots,n$ and $t=1,\ldots, T$:
\[r_{i,t} = \beta_0 + x_{i,t}^\top\beta + z_{i}^\top\gamma + u_{i} + \varepsilon_{i,t}\]

with response $r_{i,t}$ being the excess return of stock $i$ at time $t$ computed as specified in Section "Data". $x_{i,t}$ a vector of $p$ time varying predictors, and $z_i$ a vector of $n$ time-invariant covariates for the stock $i$ known at time $t$. $u_{i}$ are firm specific random effects and $\varepsilon_{i,t}$  is an error term both with finite second moments and uncorrelated with $(x_{i,t}, z_{i})^\top$ for all $i=1, \dots,n$ and $T=1, \ldots,T$.

The model can be rewritten as:

\[r_{i,t} = \beta_0 + x_{i,t}^\top\beta + z_{i}^\top\gamma+v_{i,t}.\]

where $v_{i,t} = u_{i} + \varepsilon_{it}$.

The conditional expectile regression of @Newey1987 aims at finding the conditional expectile (given the covariates $x_{i,t}$ and $z_i$):

\[e_\tau(r_{i,t}|x_{i,t},z_i) = x_{i,t}^\top \beta_\tau + z_{i}^\top \gamma_\tau, i=1,\ldots, n, t=1,\ldots T,\]

or in terms of the responses $r_{i,t}$:

\[r_{i,t} = x_{i,t}^\top \beta_\tau + z_{i}^\top \gamma_\tau + v_{\tau,i,t}\]

where $v_{\tau,i,t}$ is the error term with $e_\tau(v_{\tau,i,t}|x_{i,t},z_i)=0$ and $\tau\in (0,1)$ is the expectile level which specifies the desired "extremeness" level as @Kneib2013.

The related estimator minimizes the expectile loss function:

\[\arg\min_{\beta\in\mathbb R^p}\frac 1n\sum_{i=1}^n\sum_{t=1}^T\rho_\tau\Big(r_{i,t} - x_{i,t}\beta(\tau)\Big)\]

with $\rho_\tau(y)=|\tau - \mathbf 1(y<0)|y^2$ is the expectile check function.

The resulting estimator has the form:
\[\hat\beta_\tau = \Big(\sum_{i=1}^n\sum_{t=1}^T\hat w_{i,t} (\tau)x_{i,t}x_{i,t}^\top\Big)^{-1}\Big(\sum_{i=1}^n\sum_{t=1}^T\hat w_{i,t} (\tau)x_{i,t}r_{i,t}\Big)\]

with $\hat w_{i,t}(\tau) = |\tau - \mathbf 1(r_{i,t}\leq x_{i,t}\hat\beta(\tau))|$

and can be computed via iterative weighted asymmetric least squares as proposed by @Newey1987 on pooled data.

@BARRY2016 show asymptotic normality of the estimator under mild assumptions:

\[\sqrt{n}(\hat \beta_\tau - \beta_\tau)\rightarrow \mathcal N(0,H^{-1}\Sigma H^{-1})\]

The variances-covariances matrix of the estimator can be estimated via:

\[\hat H=X^\top\hat W X/n, \text{where } \hat W = diag(\hat w_{1,1}(\tau),\ldots,\hat w_{n,T})\]

and \[\hat \Sigma = X^\top\hat W\hat\varepsilon\hat \varepsilon^\top\hat WX/n\].

We compute robust standard errors for the ER-coefficients with R-Package sandwich (@Zeileis2020) allowing for cross-sectional and serial error dependence.

## ER with proxies of investor opinion

Our basis model specification is:

\[\begin{align}
e_\tau(r_{i,t}) = &\beta_{0,\tau} + \beta_{1,\tau}\cdot turn_{i,t-1}+\beta_{2,\tau}\cdot pre\_ean_{i,t} + \beta_{3,\tau}\cdot ean_{i,t} + \beta_{4,\tau}\cdot news_{i,t} \\
&+\beta_{5,\tau}\cdot \log(size_{i,t}) + \beta_{6,\tau} \cdot btm_{i,t-1} + \beta_{7,\tau}\cdot days\_ean_{i,t}\cdot turn_{i,t-1}+ \beta_{8,\tau}\cdot (btm_{i,t-1}<1)\cdot ean_{i,t}\\
& + \beta_{9,\tau}\cdot surp_{i,t-1} + \beta_{10,\tau}\cdot lm\_tone_{i,t} + \beta_{11,\tau}\cdot hv\_tone_{i,t} + \beta_{12,\tau}\cdot ml\_tone_{i,t} + \gamma_{1,\tau}^{\top}\cdot sector_{i}+ \gamma_{2,\tau}^\top\cdot firm_{i}(\#eq:mod0)
\end{align}\]

 with
 
 - $r_{i,t}$ the excess return of equity $i$ at time $t$, computed as ...
 
 - $turn_{i,t-1}$ share turnover of company $i$ in $t-1$
 
 - $pre_ean_{i,t}$ indicator the day before an earnings announcement referred to company $i$ 
 
 - $ean_{i,t}$ indicator whether an earnings announcement referred to company $i$ has been released at $t$
 
 - $post_ean_{i,t}$ indicator the day after an earnings announcement referred to company $i$ 
 
 - $days_ean_{i,t}$ indicator a three-day period around an earnings announcement referred to company $i$ 
 
 - $news_{i,t}$ indicator whether a news report referred to company $i$ has been released at $t$
 
 - $\log(size_{i,t})$ the logarithm of the size? of the company 
 
 - $btm_{i,t-1}$ the book-to-market ratio of company $i$ in $t-1$
 
 - $surp_{i,t}$ earnings surprise in $\%$ at $t$ according to an earnings announcement and analysts forecast referred to company $i$
 
 - $lm\_tone_{i,t}$ and $hv\_tone_{i,t}$ are news polarity or sentiment measures obtained by using LM and HV dictionary respectively. These measures are computed as $\frac{\#\text{ of positive words} - \# \text{ of negative words}}{\#\text{ of positive words}+\# \text{ of negative words}}$ using the corresponding dictionary.
 
 - $ml\_tone_{i,t}$ out-of-sample return forecast obtained using random forest with news content as explanatory variable.
 
 - $sector_{i}$ and $firm_{i}$ are the associated sector/firm dummy variables of the form $(0,0,\ldots,0,1,0,\ldots,0)$.
 

Within our model, we control for the effects of investor attention ($\beta_1$ to $\beta_4$), for the effects of investor perception ($\beta_5$ to $\beta_8$), as well as the effects of investor sentiment ($\beta_{9}$ to $\beta_{12}$).
 
We fit the models as specified in Equation \@ref(eq:mod0) for $\tau\in\{0.05,0.1,\ldots,0.95\}$ and show the resulting coefficients, their significance (based on robust covariance matrix) and the associated $R^2$ in Table \@ref(tab:table1).

```{r,echo=FALSE}
#I(turnover*news) effect of different opinions of 
#I(size*news) effect difference for small and large firms
ind_use<-which(!is.na(data$btm1)&!data$Year%in%c("")&!as.character(data$Ticker)%in%c(""))#,AGI","AMD","CHK","TWTR"))
formul<-as.formula("r_.ab.~ turnover1 +pre_ean+ean+post_ean+news+log(Size)+ btm1  + I(turnover1*days_ean)+ I((btm1<1)*post_ean) +I(surprise*100) + LM.TONE + HIV4.TONE + ML.TONE+ Sector+Ticker")

taus_mod<-c(0.005,0.01,seq(0.05,0.95,by=0.05),0.99,0.995)
mod0<-fit_eeffects(formul=formul,dat=data[ind_use,],taus=taus_mod)

```


```{r table1,echo=FALSE}
#load("mod0.RData")
mod<-mod0
make_knitr_table_all(mod, which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),taus=taus_mod)

```

As reported in \@ref(tab:table1), many of the effects are insignificant for the conditional mean return but become significant for the conditional $\tau$-expectiles with $\tau\not=0.5$. That is, higher moments of the conditional distribution are affected by the considered investment opinion channel proxies. Also, the explained weighted variance proportion becomes higher in the tails of the conditional return distribution. Moreover, some of the effects appear to be significant only for lower ($(btm_{i,t-1}<1)\cdot post\_ean_{i,t}$, $surp_{i,t}$and $hv_tone_{i,t}$) and some - only for higher expectiles  ($turn_{i,t}$, $\log(size_{i,t})$).


In the next figure, we plot the attention related effects with $95\%$-CI in Figure \@ref(fig:figure1) across the $\tau$-values:

```{r figure1, fig.cap="Coefficient profiles of the investor attention related variables for different $\\tau$-levels", echo=FALSE}
effe<-"lm"# which effect is measured lm, hv, ml            
lbls<-c(bquote(turn[it-1]),bquote(pre_ean[it]),bquote(ean[it]),bquote(post_ean[it]),bquote(news[it]))
al<-0.95
wo<-c("turnover1" ,"pre_ean","ean","post_ean","news")

plot_eefects(mod,which_ones=wo,which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),lbls=lbls[1:length(wo)])

```
Note that the effects of $turn_{i,t-1}$, $ean_{i,t}$ and $news_{i,t}$ are negative for low expectiles and become positive for higher $\tau$-levels. For the effect of $pre\_ean_{i,t}$ the opposite holds. We explain the findings with buyer excitement ("the rumor") on the days before the earnings announcements and seller excitement at news arrivals ("the news") for low expectiles of return.


Now we inspect the effects related to investor perception with $95\%$-CI in Figure \@ref(fig:figure2):

```{r figure2, fig.cap="Coefficient profiles of the investor perception related variables for different $\\tau$-levels", echo=FALSE}
effe<-"lm"# which effect is measured lm, hv, ml            
lbls<-c(bquote(btm[it-1]),bquote(log(size)[it]),bquote(turn[it-1]*days_ean[it]),bquote((btm[it-1]<1)*post_ean[it])
)
al<-0.95
wo<-c("btm1","log(Size)","I(turnover1 * days_ean)","I((btm1 < 1) * post_ean)")#, "I(turnover1 * news)")

plot_eefects(mod,which_ones=wo,which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),lbls=lbls[1:length(wo)])

```
The effects of $btm_{i,t-1}$ and turnover around earnings announecements appear to be negative for low expectiles and become increasingly positive for higher $\tau$ indicating their particular importance in extreme states of the market. $\log(size)$ exhibits increasingly negative influence for higher return expectiles. According to the results, the returns of firms with small btm ratio smaller than one and low return states undergo a negative correction in the post earnings day.

In the next figure we plot the effects related to investor sentiment with $95\%$-CI in Figure \@ref(fig:figure3):

```{r figure3, fig.cap="Coefficient profiles of the investor sentiment related variables for different $\\tau$-levels", echo=FALSE}
effe<-"lm"# which effect is measured lm, hv, ml            
lbls<-c(bquote(surp[it]),bquote(lm_tone[it]),bquote(hv_tone[it]), 
       bquote(ml_tone[it])
)
al<-0.95
wo<-c("I(surprise * 100)","LM.TONE","HIV4.TONE","ML.TONE")

plot_eefects(mod,which_ones=wo,which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),lbls=lbls[1:length(wo)])

```
The effect of earnings surprises $surp_{i,t}$ is solely for low expectiles significant. Whereas the effects of $lm\_tone_{i,t}$ and $ml\_tone_{i,t}$ do not differ significantly from a constant one across expectiles, $hv\_tone_{i,t}$ seems to have an increasing impact on low return expectiles. Overall, the sentiment effects are positive, that is, the sign of the sentiment tone determines the expected direction of the conditional return reaction.

```{r,echo=FALSE}

lmtone_list<-split(data$LM.TONE[data$news==1],data$crab[data$news==1])
hvtone_list<-split(data$HIV4.TONE[data$news==1],data$crab[data$news==1])
mltone_list<-split(data$ML.TONE[data$news==1],data$crab[data$news==1])
# surp_list<-split(data$surprise[data$ean==1],data$crab[data$ean==1])

mposlm<-unlist(lapply(lmtone_list,function(x){mean(x[x>0])}))
mposhv<-unlist(lapply(hvtone_list,function(x){mean(x[x>0])}))
mposml<-unlist(lapply(mltone_list,function(x){mean(x[x>0])}))

mposs<-c(mposlm[1],mposhv[1],mposml[1])

tau_exmpl<-0.05

coefss<-c(mod$coefs["LM.TONE",which(taus_mod==tau_exmpl)],mod$coefs["HIV4.TONE",which(taus_mod==tau_exmpl)], mod$coefs["ML.TONE",which(taus_mod==tau_exmpl)])
scoefs<-c(mod$ses["LM.TONE",which(taus_mod==tau_exmpl)], mod$ses["HIV4.TONE",which(taus_mod==tau_exmpl)],mod$ses["ML.TONE",which(taus_mod==tau_exmpl)])
lcoefs<-coefss-qnorm(1-al/2)*scoefs
hcoefs<-coefss+qnorm(1-al/2)*scoefs



mnews<-mod$coefs["news",which(taus_mod==tau_exmpl)]+sum(coefss*mposs)
lnews<-mod$coefs["news",which(taus_mod==tau_exmpl)]+ qnorm(1-al/2)*mod$ses["news",which(taus_mod==tau_exmpl)]+sum(lcoefs*mposs)
hnews<-mod$coefs["news",which(taus_mod==tau_exmpl)]- qnorm(1-al/2)*mod$ses["news",which(taus_mod==tau_exmpl)]+sum(hcoefs*mposs)

```

In summary, the effect of news arrivals is positive for higher expectiles and is sharpened by the sign of the associated sentiment tone. However, we observe a strongly negative effect of news arrivals for low return expectiles regardless of the news tone. For example, given the data, the typical positive sentiment proxies given returns lower than $\hat e_{0.05}$ (means for the given return subset) are $`r round(mposs,5)`$, the respective coefficient for the $5\%$-expectile on news arrivals is \(`r round(mod0$coefs["news",1],5)`(`r round(mod0$coefs["news",1]- qnorm(1-al/2)*mod0$ses["news",1],5)`, `r round(mod0$coefs["news",1]+ qnorm(1-al/2)*mod0$ses["news",1],4)`)\), on $lm\_tone_{i,t}$ is \(`r round(coefss[1],5)`(`r round(lcoefs[1],5)`, `r round(hcoefs[1],5)`)\), on $hv\_tone_{i,t}$ is \(`r round(coefss[2],5)`(`r round(lcoefs[2],5)`, `r round(hcoefs[2],5)`)\), and on on $ml\_tone_{i,t}$ is \(`r round(coefss[3],5)`(`r round(lcoefs[3],5)`, `r round(hcoefs[3],5)`)\). So the net effect of the "mean" empirical tone for the $5\%$ expectile would be: 
\[`r round(mnews,5)` (`r round(lnews,5)`,`r round(hnews,5)`)\]

with an asymptotic $95\%$-confidence interval given in brackets.


That is, in low return state also positive news can lead to a negative effect on the excess return. We explain this effect with the buyer excitement prior to earnings announcements following by seller excitement on news days for returns in lower expectiles connected to the trading strategy 'Buy on rumor, sell on news' for the low return state. That is, some investors tend to buy equities with low returns when they expect their growth (the 'rumor' part)  (when they are believed to be underpriced) and sell low return stocks to ride on the hype of positive news arrivals. 

This effect can be also connected to the 'sidedness' of @SARKAR2009. The negative effect of (even positive) news can be explained by disproportionaly higher seller quote at news arrivals in case of low performing equities. The positive effect of btm ratio arises as a result of buyer 'sidedness' hunting the equities with low returns but promising expected performance (high btm).
 
<!-- maybe also this as explaination on limit-order-book level: https://www.sciencedirect.com/science/article/abs/pii/S2214635014000240  -->


```{r,echo=FALSE}
#save(file="mod0.RData",mod0)
#rm(mod0)
```


# Impact of investor opinion on the conditional expected shortfall of the returns

A frequently used risk measure is the $\alpha$-expected shortfall, denoted as $ES_{\alpha}$. It is connected to the quantile $q_\alpha$ of the target distribution. For the lower tail of the later this risk measure is defined as $ES_\alpha = \mathbb E(Y|Y<q_\alpha)$. 

@JONES1994 shows that there is a one-to-one correspondence between quantiles and expectiles of a distribution. Based thereof, @Taylor2008 proposes to use expectiles to estimate $ES_{\alpha}$ with $\alpha\leq 0.5$ via:

\begin{align}
ES_{\alpha} &= \left(1+\frac{\tau}{(1-2\tau)\alpha}\right)e_{\tau} - \frac{\tau}{(1-2\tau)\alpha}e_{0.5},
\end{align}

where $\alpha\in(0,0.5]$ denotes the quantile level, $\tau\in(0,1)$ is the associated expectile level, and $e_{\tau}$ is the respective expectile. As @Taylor2008, the same relation holds for the conditional expected shortfall with respect to the conditional expectile.

@yao1996 show the existence of a bijective function $\tau:(0,1)\rightarrow (0,1)$  which connects the quantile level $\alpha$ to the expectile level $\tau$ such that $q_\alpha = e_{\tau(\alpha)}$.

<!--Using the results of @yao1996\footnote{@yao1996 specify $\tau(\alpha)$ as: 
\[\tau(\alpha) = \frac{-\alpha q_\alpha + G(q_\alpha)}{-e_{0.5} + 2G(q_\alpha) + (1+2\alpha)q_\alpha},\]
where $G(q)=\int_{-\infty}^qydF(y)$ is the partial moment function and $F(y)$ is the cumulative distribution function (cdf) of $y$.}
@Waltrup2015 further connect the corresponding tail index estimates $\hat q_\alpha$ and $\hat e_{\hat \tau(\alpha)}:=\hat e_\hat\tau$ through estimating $\hat\tau(\alpha)$ from the data and show that such expectile based estimates are more efficient in simulations.
-->

Thus, if the relation $\hat\tau(\alpha)$ or its estimate $\hat \tau(\alpha)$ is available, a plug-in estimator for the expected conditional shortfall based on the estimated conditional expectile analog to the autoregressive version in @Taylor2008 can be obtained:

\[\begin{align}
ES_{\alpha}(r_{i,t}|x_{i,t},z_i) &= \left(1+\frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}\right)e_{\hat\tau(\alpha)}(r_{i,t}|x_{i,t},z_i) - \frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}e_{0.5}(r_{i,t}|x_{i,t},z_i)\nonumber\\
&=\tilde \beta_{0,\alpha} + \tilde\beta_{\alpha}^\top \cdot x_{i,t} + \tilde\gamma_\alpha^\top\cdot z_i,(\#eq:es)
\end{align}\]

<!--where $\tilde\beta = \left(1+\frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}\right)\cdot \hat \beta_{\hat\tau(\alpha)} - \frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha} \cdot \hat\beta_{0.5}$
-->

with

\[\begin{align}\tilde\beta_\alpha &= \hat \beta_{\hat\tau(\alpha)} - \frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}\cdot \left(\hat\beta_{0.5} -\hat \beta_{\hat\tau(\alpha)}\right)(\#eq:tbeta)\end{align}\]

and $\tilde\beta_0$ and $\tilde\gamma$ are defined analogous.

To obtain the actual estimates, we first estimate the conditional expectile model as in \@ref(eq:mod0) for a fine grid of $\tau = 0.001, 0.0025, 0.005,0.01,0.02,\ldots, 0.1$. Following @Taylor2018, we construct an empirical cumulative distribution function by counting the observations below the estimated expectile profile for each of the $\tau$-levels, such that for each $\tau$ we have the corresponding quantile index $\alpha$. We then interpolate linearly between the resulting points to obtain $\hat\tau(\alpha)$ particular for $\alpha\in\{0.01,0.05,0.1\}$. The estimated correspondence is plotted in Figure \@ref(fig:figure4).


```{r, echo=FALSE}
## for a range of tau values compute the expectile
# taus_f<-c(0.001,0.0025,0.005,0.01,seq(0.01,0.08,0.01))
# mod_f<-fit_eeffects(formul=formul,dat=data[ind_use,],taus=taus_f)
# #save(mod_f, file="mod_f.RData")
# e_taus_f<-unlist(lapply(mod_f$mods,fitted)); e_taus_f<-matrix(e_taus_f,,length(mod_f$mods))
# alphas_f<-apply(e_taus_f,2,function(q,x){sum(x<q)}, x=data$r_.ab.[ind_use])/length(data$r_.ab.[ind_use])
# 
# tau_alpha<-cbind(taus_f,alphas_f)
# colnames(tau_alpha) = c("tau","alpha")
# 
# save(tau_alpha, file="tau_alpha.RData")


load("tau_alpha.RData")

#linear interpolation
tau_new = approx(tau_alpha[,2], tau_alpha[,1], xout=c(0.01,0.05,0.1))
#new model for the target tau
mod_new<-fit_eeffects(formul=formul,dat=data[ind_use,],taus=c(tau_new$y,0.5))
#load("mod_new.RData")
```


For instance, in our model specification the lower quantile levels $\alpha\in\{0.01,0.05,0.1\}$ correspond to the expectile levels $\tau\in\{`r paste(round(tau_new[[2]],4), collapse=",")`\}$ respectively.

```{r,figure4, fig.cap="The estimated relation between the expectile level $\tau$ and the quantile level $\alpha$ for the NASDAQ return distribution", echo=FALSE}
plot(tau_alpha[,2],tau_alpha[,1], type="l",ylim=c(0,0.12),xlim=c(0,0.15), ylab="", xlab="", axes=F)

points(tau_new$x,tau_new$y,col=2, pch=16)
axis(1, at=c(0,0.01,0.05,0.1,0.15), labels=c(0,0.01,0.05,0.1,0.15))
axis(2, las=1, at=c(0,0.05,0.1), labels=c(0,0.05,0.1))
par(xpd=T)

text(0,0.11,bquote(hat(tau)(alpha)))
text(0.155,0,bquote(alpha))
arrows(c(0.01,0.05,0.1),rep(-0.004,3),tau_new$x,tau_new$y, col=2, lty=2,code=0)
arrows(rep(-0.005,3), tau_new$y, tau_new$x,tau_new$y,col=2, lty=2,code=0)
#text(0.01, tau_new$y[1]+0.01, bquote(hat(tau)(0.01)==0.0055),cex=0.7)

text(-0.012, tau_new$y[1]+0.002, round(tau_new$y[1],4),cex=0.7,col=2)
text(-0.012, tau_new$y[2]+0.002, round(tau_new$y[2],4),cex=0.7,col=2)
text(-0.012, tau_new$y[3]+0.002, round(tau_new$y[3],4),cex=0.7,col=2)

```


For the target $\alpha\in\{0.01,0.05,0.1\}$ we compute the resulting coefficients $\tilde\beta_\alpha$ which stand for the investor opinion effects on the conditional expected shortfall. The associated $95\%$ confidence intervals are obtained by cross-sectional and temporal bootstrap as defined in @Kapetanios2008. To preserve the possible serial dependence structure we use block bootstrap for the time-series dimension with block length of $60$. 

```{r, echo=FALSE}
target_alphas<-c(0.01,0.05,0.1)
which_ones=(1:14)
tbeta0<-list(0)
for(j in 1:length(target_alphas)){
     tbeta0[[j]]<-mod_new$coefs[which_ones,j] -
       tau_new$y[j]/((1-2*tau_new$y[j])*target_alphas[j])*(mod_new$coefs[which_ones,ncol(mod_new$coefs)]-mod_new$coefs[which_ones,j])
   }
```


The bootstrapping is carried out as follows. For each bootstrap draw $b=1,\ldots, B$, we, first, estimate the ER model for a fine grid of $\tau$-values in the left tail $0.001,0.0025,0.005,0.01,0.02,\ldots,0.1$. Then using the fitted conditional expectiles, we estimate the correspondence $\hat\tau^{(b)}(\alpha)$ by assigning to each $\tau$-value the proportion of observations $\alpha$ in the bootstrap sample lying below the expectile profile $\{e_{tau}(r^{(b)}_{it})\}_{i=1,t=1}^{N,T}$. By interpolating linearly between the points, we determine the needed $\tau$-levels for the target $\alpha$-levels of $0.01,0.05,0.1$. The estimated $\hat\tau(\alpha)$ with $95\%$ bootstrap confidence intervals is presented in Figure \@ref(fig:figure5).

Finally, we compute $\tilde\beta^{(b)}_\alpha$ for each bootstrap sample as specified in \@ref(eq:tbeta), that is:
\[\tilde\beta^{(b)}_\alpha = \hat \beta^{(b)}_{\hat\tau^{(b)}(\alpha)} - \frac{\hat\tau^{(b)}(\alpha)}{\big(1-2\hat\tau^{(b)}(\alpha)\big)\alpha}\cdot \left(\hat\beta_{0.5} -\hat \beta_{\hat\tau^{(b)}(\alpha)}\right).\]
Based on the resulting bootstrap distribution of $\left\{\tilde\beta^{(b)}_\alpha\right\}_{b=1}^B$ we, then, construct the confidence intervals.

```{r, echo=FALSE}
# ## bootstrapping the confidence intervals (run on server)
# 
# # bootstrap preparation
# 
# #T
# dates<-unique(data$Date)
# period<-60
# periods_start<-seq(1,length(dates)-period,by=period)
# 
# blocksT<-list(0)
# 
# for(i in 1:length(periods_start)){
#   blocksT[[i]]<-dates[seq(periods_start[i], by=1, length.out=period)]
# }
# 
# #N
# individs<-unique(data$Ticker)
# 
# 
# 
# #params
# which_ones = (1:14)
# target_alphas<-c(0.01,0.05,0.1)
# 
# 
# #boot size
# B<-100
# 
# 
# #tau(alpha) placeholder
# tau_alpha_b<-matrix(NA,nrow(tau_alpha),B)
# rownames(tau_alpha_b)<-tau_alpha[,1]
# 
# tbeta<-list(matrix(NA,length(which_ones),B),
#             matrix(NA,length(which_ones),B),
#             matrix(NA,length(which_ones),B)
#             )

```


```{r, echo=FALSE}
# BB=100
# for (b in 1:BB){
#   print(b)
#   set.seed(123+b)
#   ############bootstrap
#   #T
#   bootT<-sample.int(length(blocksT),replace=T)
#   dataBoot<-NULL
#   for(i in bootT){
#     dataBoot<-rbind(dataBoot,data[data$Date%in%blocksT[[i]],])
#   }
#   #N
#   indiv<-individs[sample.int(length(individs),replace=T)]
#   dataBootTN<-NULL
#   for(i in 1:length(indiv)){
#     dataBootTN<-rbind(dataBootTN,dataBoot[dataBoot$Ticker==indiv[i],])
#   }
#   dataBootTN<-data.frame(dataBootTN)
#   
#   ###############estimate tau(alpha)
#   ind_use<-which(!is.na(dataBootTN$btm1))
#   mod_b<-fit_eeffects(formul=formul,dat=dataBootTN[ind_use,],taus=tau_alpha[,1])
#   e_taus_f<-unlist(lapply(mod_b$mods,fitted)); e_taus_f<-matrix(e_taus_f,,length(mod_b$mods))
#   tau_alpha_b[,b]<-apply(e_taus_f,2,function(q,x){sum(x<q)},
#                          x=dataBootTN$r_.ab.[ind_use])/length(dataBootTN$r_.ab.[ind_use])
#   #linear interpolation
#   tau_new_b = approx(tau_alpha_b[,b], tau_alpha[,1], xout=target_alphas)[[2]]
#   
#   ##############re-estimate the model for the target taus
#   mod_b<-fit_eeffects(formul=formul,dat=dataBootTN[ind_use,],taus=c(tau_new_b,0.5))
#   coefsBoot<-mod_b$coefs[which_ones,]
#   
#   #compute ES coefs
#   for(j in 1:length(target_alphas)){
#     tbeta[[j]][,b]<-coefsBoot[which_ones,j] -
#       tau_new_b[j]/((1-2*tau_new_b[j])*target_alphas[j])*(coefsBoot[which_ones,ncol(coefsBoot)]-coefsBoot[which_ones,j])
#   }
#   
# 
# }

```




```{r, echo=FALSE}
#load("tau_alpha.RData")
load("tau_alpha_b.RData")
load("tbeta.RData")
```


```{r, figure5, fig.cap="The estimated relation between the expectile level $\\tau$ and the quantile level $\\alpha$ using the original NASDAQ return data (solid thick line) with boostrap based mean (dashed line) and $95\\%$ confidence intervals (solid thin lines).", echo=FALSE}
library(scales)
plot(tau_alpha[,2], tau_alpha[,1],type="l",col=NA, ylab="", xlab="", axes=F, ylim=c(0,0.06), xlim=c(0,0.1))

axis(1, at=c(0,0.01,0.05,0.1), labels=c(0,0.01,0.05,0.1))
axis(2, las=1, at=c(0,0.03,0.06), labels=c(0,0.03,0.06))
par(xpd=T)

text(0,0.06,bquote(hat(tau)(alpha)))
text(0.11,0,bquote(alpha))

#text(0.01, tau_new$y[1]+0.01, bquote(hat(tau)(0.01)==0.0055),cex=0.7))
# for(i in 1:ncol(tau_alpha_b)){
#   lines(rownames(tau_alpha_b), tau_alpha_b[,i], col=alpha("gray44",0.3))
# }
lines(apply(tau_alpha_b,1,mean), rownames(tau_alpha_b), col=1,lwd=3,lty=2)
lines(apply(tau_alpha_b,1,quantile,0.025), rownames(tau_alpha_b), col="gray44",lty=1,lwd=2)
lines(apply(tau_alpha_b,1,quantile,0.975), rownames(tau_alpha_b), col="gray44",lty=1,lwd=2)
lines(tau_alpha[,2], tau_alpha[,1], lwd=3,col=alpha("gray44",0.8))
```
```{r, echo=FALSE}
#compute 95% ci
tbeta_m<-tbeta_h<-tbeta_l<-NULL
for(i in 1:length(tbeta)){
  tbeta_m<-cbind(tbeta_m, apply(tbeta[[i]],1,mean))
  tbeta_h<-cbind(tbeta_h, apply(tbeta[[i]],1,quantile, 0.975))
  tbeta_l<-cbind(tbeta_l, apply(tbeta[[i]],1,quantile, 0.025))
}
```

```{r, echo=FALSE}
# #plot 95% ci
# par(mfrow=c(2,2))
# for(i in 1:length(target_alphas)){
#   plot(1:14,tbeta0[[i]],type="l",col=NA,ylim=c(-0.5,0.5))
# 
# lines(1:14, apply(tbeta[[i]],1,mean), col=1,lwd=3)
# lines(1:14, apply(tbeta[[i]],1,quantile,0.025), col=4,lty=2,lwd=3)
# lines(1:14, apply(tbeta[[i]],1,quantile,0.975), col=4,lty=2,lwd=3)
# lines(1:14, tbeta0[[i]], lwd=3,col=alpha(4,0.8))
# abline(h=0, lwd=1,col=2)
# }

```

```{r, echo=FALSE}
options(scipen=999)
tab<-cbind(paste0(round(tbeta[[1]][which_ones],4)," (",round(tbeta_l[which_ones,1],4),",",round(tbeta_h[which_ones,1],4),")"),
           paste(round(tbeta[[2]][which_ones],4)," (",round(tbeta_l[which_ones,2],4),",",round(tbeta_h[which_ones,2],4),")"),
           paste(round(tbeta[[3]][which_ones],4)," (",round(tbeta_l[which_ones,3],4),",",round(tbeta_h[which_ones,3],4),")")
                                            )
ind_sign<-cbind((tbeta_h[which_ones,1]>0&tbeta_l[which_ones,1]>0)|(tbeta_h[which_ones,1]<0&tbeta_l[which_ones,1]<0),
                (tbeta_h[which_ones,2]>0&tbeta_l[which_ones,2]>0)|(tbeta_h[which_ones,2]<0&tbeta_l[which_ones,2]<0),
                (tbeta_h[which_ones,3]>0&tbeta_l[which_ones,3]>0)|(tbeta_h[which_ones,3]<0&tbeta_l[which_ones,3]<0))
tab[ind_sign]<-paste0("**",tab[ind_sign],"**") # paste signif coefs in bold

colnames(tab)<-c("$ES_{0.01}$", "$ES_{0.05}$","$ES_{0.1}$")
rownames(tab)<-c("Constant","$turn_{i,t-1}$","$pre\\_ean_{i,t}$","$ean_{i,t}$","$post\\_ean_{i,t}$","$news_{i,t}$",
                                           "$\\log(size_{i,t})$","$btm_{i,t-1}$", "$turn_{i,t-1}*days\\_ean_{i,t}$", "$(btm_{i,t-1}\\leq 1)*post\\_ean_{i,t}$",
                                           "$supr_{i,t}$",  "$lm\\_tone_{i,t}$", "$hv\\_tone_{i,t}$", "$ml\\_tone_{i,t}$")

caption<-"The estimated coefficients $\\tilde\\beta_\\alpha$ measuring the effects of investor opinion on the expected shortfall. The $95\\%$ bootstrap confidence intervals are given in brakets."

 knitr::kable(tab, align = "llll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )

```
For $\alpha = 0.01,0.05$ and $0.1$ we confirm significant effects of $pre\_ean$, $ean$, $news$, turnover around earnings announcement days $turn\cdot days\_ean$ and the post earnings announcements effect of btm ratio smaller than one $(btm\leq 1)\cdot post\_ean$ for $\alpha=0.01$. Neither $lm\_tone$ nor $ml\_tone$ show significant impact. However, for $hv\_tone$ we find a significant effect for $\alpha=0.05$ and $0.1$.

As in the case of conditional expectile model, earnings announcements and shares turnover around earnings announcements exhibit significant negative effects on the conditional expected shortfall. Also, that the mentioned "buy on rumor, sell on news" effect (positive coefficient estimate for $pre\_ean$ and negative for $news$) persists in the conditional expected shortfall as well making it risk management relevant. 

# Conclusion

We analyzed the distributional effects of investor opinion on asset returns based on a panel of NASDAQ excess returns for the time period of April 2015 - August 2019. We adopt the information flow structure of @Su2021 where investor opinion comprises such channels as investor attention, perception and sentiment. We chose the proxies for each of the channel based on the previous studies and used them as covariates in an expectile regression model introduced by @Newey1987 with excess return as response to assess the distributional effects beyond the conditional mean regression and without imposing any assumptions on the response distribution. The majority of the estimated effects depends on the expectile level or "extremeness" $\tau$ in a nonlinear way and the associated estimates change sign when moving from the left to the right tail or vice versa of the conditional response distribution. Particularly interesting appears the "buy on rumor, sell on news" effect for low expectiles fetching a positive influence of days before the earnings announcements following by downwards correction on news events (including the earnings announcements) regardless to their polarity. Moreover, the same significant effect is found in the conditional expected shortfall model, which we obtained by plugging in our conditional expectile formulation in the expected-shortfall-expectile relation derived by @Taylor2008. Our findings are thus have important implications for risk management assessment of investor opinion channels.

# References

<div id="refs"></div>
