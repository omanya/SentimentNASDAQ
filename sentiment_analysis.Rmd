---
title: "Investor opinion formation and the distribution of stock returns"
author: Maria Osipenko^[Hochschule für Wirtschaft und Recht Berlin; osipenko@hwr-berlin.de], Rui Ren^[Universität Augsburg]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::pdf_document2:
    extra_dependencies: ["tabularx"]
    toc: false
    fig_caption: yes
    keep_tex: true
    link-citations: true
bibliography: [packages.bib, references.bib] 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Abstract {-}

We study how the distribution of stock returns is influenced through different investor opinion formation channels by applying expectile regression to abnormal NASDAQ returns over the period April 2015 - August 2019. Thereby, we differentiate between the aspects of investor attention, perception and sentiment and use firm and time specific proxies for each of the aspects such purely financial indicators as book to market ratio, scheduled and unscheduled events as earnings announcements and news releases, as well as textual sentiment of the news content.

We find, that the concerned effects depend on the expectile level \(\tau\), which itself can be understood as the `state of the world' or 'extremeness level' of individual abnormal returns. While not always significant for the mean regression, the proxies of the investment opinion formation channels show significant effects on the conditional distribution of asset returns beyond its mean.

When analyzing the effect of news arrivals and earnings announcements, we find a negative impact of these events on low return expectiles even if the news itself is positive. One possible explanation of this phenomena are trading patterns aligned with the strategy ``sell on news'' for the low return states.

Our expectile regression approach allows us to naturally generalize the previous studies of conditional mean regression to higher conditional moments and estimate investor opinion impact thereon. Moreover, using the relation of expectiles to expected shortfall we explore significant effects of investor opinion formation channels on conditional expected shortfall as well.

```{r,echo=FALSE, include=FALSE}
#citations for the packages
knitr::write_bib(c("knitr", "rmarkdown", "sandwich", "expectreg"), width = 60,file ="packages.bib")
```


# Introduction {-}

The effects of public information flow as news arrivals and news sentiment on stock returns and the question whether they make up good predictors of the later have captured attention of many researches. However the results are somewhat fragmented and debatable. 

For instance, @HAGENAU2013 and @NGUYEN2015 are able to significantly improve their return forecasts by using sentiment from news or social media. @SHANG2014 find a significant effect of sentiment only related to the negative announcements.  @Antweiler2004 claim that the number and the extent of text messages influences stock volatility but not returns.  @DAS2007 observe that the message volume (regarded as optimistic sentiment) is positively correlated with stock volatility but negatively correlated with stock returns. @KIM2014 find no evidence for predictive power of sentiment neither on returns nor on volatility or trading volume. Recently, @AUDRINO2020 and @FANG2021 again report an improvement in volatility forecasts on using sentiment from news and social media. @CAMPBELL1992 incorporates an asymmetric news-about-dividends impact on return volatility in a GARCH-type model. Further focusing on this effect and using broad firm specific news arrivals as a proxy for information flow @KALEV2004 report significant effects on intraday and daily level. The authors write "when public news is released, market activity intensifies as a result of belief revisions caused by the divergence of opinions among traders". @Maheu2004 also find empirical evidence for an asymmetric effect of positive and negative news on volatility jumps. The authors infer the positiveness or negativeness using the earnings surprises without any textual analysis of news content. Thereby they assume, that a positive surprise indicates positive news and vice versa. @Luss2012 use textual features from news articles and support vector machines to predict the magnitude of stock returns. @fuess2020 build upon a sentiment-augmented factor model for excess return and a lexicon-based sentiment assessment. They report a significant improvement in model performance due to the incorporated text information. 

As seen, various ways has been undergone in order to assess the investor sentiment in its broad sense. Overall the existing approaches to measuring investor sentiment can be divided into two categories. The first one uses financial proxies to measure sentiment, as e.g. in @de1990noise, @barberis1998model, @baker2007investor. Candidate methods of measuring sentiment contain financial indicators as book-to-market ratios, earnings surprise, size (@FRIEND1988, @FAMA1992,  @KOTHARI1997, @PONTIFF1998, @Maheu2004) and event indicators as news arrivals, earnings announcements, search inquiries. @BERKMAN2009 argues that varying degree in differences in opinion regarding some stocks may influence their price dynamics around earnings announcements. Among other proxies for the opinion gap they use share turnover in the time span around earnings announcements. The authors argument that stocks with high degree of opinion differences are overpriced and earn lower return on earnings announcement days due to opinion alignment. 

The second approach is to infer investor sentiment directly from the relevant textual documents. @Su2021 classifies the related approaches as dictionary-based and machine learning based ones. The first one relies on word lists with positive and negative words with the most famous dictionaries - Harvard (HV) and Loughran \& McDonald word lists (e.g. @LOUGHRAN2011, @JEGADEESH2013). The machine learning approach uses statistical models to map the word content to a relevant variable as return (e.g. @Antweiler2004, @FANG2021).

@Su2021 break this broad interpretation of investor sentiment down to three channels, through which investor information flow may influence asset returns: *investor perception* (risk perception and individual believes), captured by financial variables, event-related *investor attention*  and *investor sentiment* in a narrow sense usually specified as positive or negative polarity of news and social media content, for instance in @FRANKEL2022.

On the model side, the limited attention hypothesis (@corwin2008 and @Loh2010) and the opinion divergence hypothesis (@BERKMAN2009 and @chatterjee2012), supported empirically, shed light on the ways these particular aspects of investor behavior influence asset pricing. @fuess2020 introduce aggregated investor sentiment in their asset pricing model. They show that the inclusion of the lexicon-based sentiment as a risk factor yields a better model performance.

In this paper we analyse the impact of the three information flow channels on the distribution of daily excess returns. Thereby we encapsulate *investor attention* using the indicators of days around earnings announcements and news arrivals.  The aggregated *Investor perception* is captured by the traditional financial fundamentals as book-to-market ratios, size, earnings surprises and a proxy for opinion differences - shares turnover around earnings announcements. Dictionary-based polarity assessment of firm-specific news content is used to proxy *investor sentiment* in its narrow sense. Our choice of the proxies is based on the empirical evidence found in the previous literature provided below.

Besides the vast amount of approaches to measuring investor information flow, there is no consensus on which parameters of the conditional return distribution are affected. Significant effects were shown for conditional return expectation (e.g. in @HAGENAU2013 and @NGUYEN2015) and for conditional variance (e.g. in @AUDRINO2020 and @FANG2021). @Cao2002 argue, that not only second but also third moments of return distribution are effected by information arrival due to inert "sidelined" investors. @ENGELBERG2018 go beyond and close up the tails of the return distribution by considering return anomalies. They find a sign-changing asymmetric effect on information days. 

In this paper, we estimate the effects of information flow channels **on the whole distribution** of asset returns by breaking it down to a fine grid of tail indices. That way we are neither constrained to a particular distributional assumption nor to certain conditional moments of the return distribution. 

A natural choice of such tail indices are quantiles (@Koenker1978) of the return distribution, $q_{\alpha}(r_{i,t})$, for a range of $\alpha$-values in $(0,1)$ capable of representing the whole return distribution without explicit distributional assumptions. By means of quantile regression for a set of $\alpha\in(0,1)$ distributional effects of investor opinions can be estimated. @NI2015, @Ma2018 and @ALNASSERI2021 use quantile regression to address the  distributional effects of the sentiment on the return. The authors find different effects for different quantile levels and point out that, overall, extreme markets are largely driven by investor sentiment.

Instead of using $\alpha$-quantiles for representing the conditional return distribution, an alternative measure $\tau$-expectiles introduced in @Newey1987 can be employed. The $\tau$-expectile is the real number, such that the $\tau$-proportion of the expected distance to it lies below and the $(1-\tau)$-proportion lies above it. As quantiles generalize the concept of the median, expectiles generalize the concept of the mean. Therefore, the expectile regression for a range of $\tau$-values in $(0,1)$ naturally generalizes the mean regression and is capable of capturing the effects on the whole distribution of returns in our case. This fact makes our analysis comparable with the previous findings based on the mean regression for $\tau=0.5$ on one hand and capable of capturing distributional effects for $\tau\in (0,1)\setminus\{0.5\}$ on the other.  

In summary, our expectile regression approach allows to study heterogeneous effects over the whole distribution of returns breaking it down to different expectile levels (similar to quantile regression), but, as opposed to quantile regression, covers the mean regression as a special case of $\tau=0.5$ and facilitates simple and efficient estimation and inference on the obtained parameters (@waltrup2015 on the efficiency of expectles, @Barry2018 for inference).

Using coefficient standard errors robust to serial and cross-sectional correlation, we confirm significant positive effect of the day before earnings announcements and a significant negative effect of news and earnings arrivals *on lower tail of return distribution* even if the polarity of the news and earnings surpises are positive. Our explanation for the effects connects to a trading strategy "buy on rumor, sell news". That is, some investors tend to buy equities with low returns when they expect their growth (the 'rumor' part)  (when they are believed to be underpriced) and sell low return stocks to ride on the hype of positive news arrivals. 

Further advantage of our expectile-based approach lies in the risk management perspective. Well-known connection of expectiles to expected shortfall (@Taylor2008) makes our investigation of the factors impacting the expectiles of the returns potentially useful for risk management insights. Using the estimated effects from our conditional expectile model, we obtain plug-in estimates for the respective effects on the conditional expected shortfall and evaluate their significance via bootstrap.

The contribution of our paper is threefold. First by incorporating all three investor opinion channels in our model, we  conduct a more extensive (comprehensive) analysis of the respective effects, which makes our approach stand out from the previous related studies. Second, we estimate the effects of information flow channels on the whole distribution of asset returns braking it down to a fine grid of tail indices - expectiles - avoiding any distributional assumptions or model constrains to particular conditional moments. Third, based on the connection of expectiles and expected shortfall, we obtain the estimated effects of the investor opinion directly on the expected shortfall for returns distribution, which is highly relevant for risk management and uncovered in the existing studies.

The rest of the paper is organized as follows. First, we introduce our data and the variables we use to proxy the investor opinion channels. Next, we describe our conditional expectile model and its estimation in detail. Presentation of the estimation results follows. Then, we describe how plug-in estimates of the effects on the conditional expected shortfall can be obtained based on our conditional expectile model, present the resulting estimates and their respective bootstrap confidence intervals. Finally, we conclude and discuss possible further research directions.


# Proxies for investor opinion formation channels

We use data for NASDAQ stocks in the period April 2015 - August 2019 obtained from Bloomberg.
Our dependent variable is the abnormal return of NASDAQ stocks in the mentioned period, computed as stock-specific return on the day of news arrival minus Center for Research in Security Prices (CRSP) value-weighted market return. The associated data on the size, the book-to-market (btm) ratios, the share turnover, and the associated sentiment features from news articles build up the set of explanatory variables.

The textual corpus in this paper contains news articles from NASDAQ News and Insights and is downloaded from the \href{https://blockchain-research-center.com/}{Blockchain Research Center}. We select the top 100 companies regarding news frequency in the final data set. The stock ticker list is provided in the Appendix. All news articles published on weekends, holidays or after 4 pm on weekdays are merged with news articles on the next trading day. 
Table \@ref(tab:table00) in Appendix describes the textual corpus used to calculate dictionary based investor sentiment measure.


We combine this data with the records on earnings announcements from https://www.kaggle.com/datasets/tsaustin/us-historical-stock-prices-with-earnings-data (accessed on 21.September 2022) containing earnings date, estimated earning per share (eps) and reported eps,  and with the sector information from NASDAQ website https://www.nasdaq.com/market-activity/stocks/screener (accessed on 10. September 2022).


```{r,echo=FALSE}
rm(list=ls())
set.seed(123)
data<-read.csv("data.csv")
data$Date<-as.Date(data$Date)

#news event
data$news<-ifelse(data$word_count>0,1,0)

news_day<-cbind(aggregate(news~Date,data, FUN=function(x){sum(x)/100}),TONE=aggregate(LM.TONE+HIV4.TONE~Date,data,sum)[,2])

colnames(news_day)[2]<-"news_day"
data<-merge(data, news_day, by.x=c("Date"),by.y=c("Date"),all.x=T)

#scale
cols_scale<-c("LM.TONE","HIV4.TONE","TONE")
scale01<-function(x){
  xx<-x
  xx[x>0]<-x[x>0]/(abs(max(x,na.rm=T)))
  xx[x<=0]<-x[x<=0]/(abs(min(x,na.rm=T)))
  return(xx)
}
data[,cols_scale]<-apply(data[,cols_scale],2,scale01)

#substitute negative btms
data$BTM[data$BTM<0]<-0

```


```{r,echo=FALSE}
#combine with sectors
sectors<-read.csv2("nasdaq_screener.csv")
data<-merge(data,sectors[,c("Symbol","Sector")], by.x=c("Ticker"),by.y=c("Symbol"),all.x=T)

news_sector<-aggregate(news~Date+Sector,data, FUN=function(x){sum(x)/length(x)})
colnames(news_sector)[3]<-"news_sector"
data<-merge(data, news_sector, by.x=c("Date", "Sector"),by.y=c("Date", "Sector"),all.x=T)

```


```{r,echo=FALSE}
#combine with earnings announcements
ean<-read.csv("./stocks_latest/earnings_latest.csv",stringsAsFactors = F)

colnames(ean)[1]<-"Ticker"

ean<-ean[ean$Ticker%in%unique(data$Ticker)&ean$date%in%unique(data$Date),]

ean$ean<-1 # indicator of rearnings
ean$eps<-as.numeric(ean$eps); ean$eps_est<-as.numeric(ean$eps_est)
ean$eps[is.na(ean$eps)]<-0

#ean$surprise<-(ean$eps-ean$eps_est)/abs(ean$eps_est)
ean$surprise<-(ean$eps-ean$eps_est)
ean$surprise[ean$eps_est==0|is.na(ean$eps_est)]<-0
ean$surprise[is.na(ean$surprise)]<-0


data<-merge(data,ean[,c("Ticker", "date","ean","surprise","eps") ], by.x=c("Date","Ticker"),by.y=c("date","Ticker"),all.x=T)
#data<-merge(data,ean, by.x=c("Date","Ticker"),by.y=c("date","Ticker"),all.x=T)

data$surprise[is.na(data$surprise)]<-0
data$ean[is.na(data$ean)]<-0
data$eps[is.na(data$eps)]<-0
data$surprise[data$ean==1]<-scale01(data$surprise[data$ean==1])

#days around th earnings announcements
data<-transform(data, days_ean=NA, pre_ean=0, post_ean=0)
data = data[order(data$Ticker,data$Date),]
tickers<-unique(data$Ticker)
for( i in 1: length(tickers)){
  ticker = tickers[i]
  indi = data$Ticker==ticker
  datai = data[indi,]
  datai = datai[order(datai$Date),]
  ind_ean = which(datai$ean==1)
  days_ean = numeric(nrow(datai))
  days_ean[c(ind_ean, ind_ean-1, ind_ean+1)]<-1
 
  data$days_ean[indi]<-days_ean
  data$pre_ean[indi][ind_ean-1]<-1
  data$post_ean[indi][ind_ean+1]<-1
}

```


```{r, echo=FALSE}
# Compute lagged/one-step ahead variables:
Ticker<-unique(data$Ticker)
data<-transform(data, btm1=NA,turnover1=NA, surprise1=NA)

for(i in 1:length(Ticker)){
  ind<-which(data$Ticker==Ticker[i])
  data$btm1[ind]<-c(NA,data$BTM[ind[-length(ind)]]) #lag of btm
  data$news1[ind]<-c(NA,data$news[ind[-length(ind)]]) #lag of news
  data$news_day1[ind]<-c(NA,data$news_day[ind[-length(ind)]]) #lag of news
  data$LM.TONE1[ind]<-c(NA,data$LM.TONE[ind[-length(ind)]]) #lag of lm
  data$HIV4.TONE1[ind]<-c(NA,data$HIV4.TONE[ind[-length(ind)]]) #lag of hv
  data$TONE1[ind]<-c(NA,data$TONE[ind[-length(ind)]]) #lag of tone
  data$turnover1[ind]<-c(NA,data$TURNOVER[ind[-length(ind)]]) #lag of turnover
  data$surprise1[ind]<-c(NA,data$surprise[ind[-length(ind)]]) #lag of surprise
 # data$eps1[ind]<-c(NA,data$eps[ind[-length(ind)]]) #lag of eps
}

#news should not overlap with ean days
data$news[data$ean>0]<-0
data$news1[data$ean>0]<-0
data$LM.TONE[data$ean>0]<-0
data$HIV4.TONE[data$ean>0]<-0
data$LM.TONE1[data$ean>0]<-0
data$HIV4.TONE1[data$ean>0]<-0
```


```{r,echo=F}
#Add event identifier
data$type2<-NA
data$type2[data$days_ean==0&data$news==0]<-"noevent"
data$type2[data$pre_ean==1]<-"pre_ean_positive"
data$type2[data$pre_ean==1&((data$HIV4.TONE+data$LM.TONE)<0)]<-"pre_ean_negative"
data$type2[data$surprise>0]<-"ean_positive"
data$type2[data$surprise<0]<-"ean_negative"
data$type2[data$post_ean==1&data$surprise1>0]<-"post_ean_positive"
data$type2[data$post_ean==1&data$surprise1<0]<-"post_ean_negative"
data$type2[data$news==1&data$days_ean==0&(data$HIV4.TONE+data$LM.TONE)>0]<-"news_positive"
data$type2[data$news==1&data$days_ean==0&(data$HIV4.TONE+data$LM.TONE<0)]<-"news_negative"

#remove tickers, where no info on earnings is available
data<-data[!data$Ticker%in%c("BHP","ATVI"),]#,"TWTR","BBBY"),]
```


```{r, echo=FALSE}
source("myfuns.R")
```


Based on the available data and on previous findings in the literature, we construct proxies for the three channels of information flow: investor attention, investor sentiment and investor perception described in the following.

**Investor attention**

@chen2022,  @daniel2020 and @dellavigna2009 among others highlight the impact of investor attention on financial markets. @dellavigna2009 refer to earnings announcements on different weekdays to capture the phenomena. @daniel2020 focus on optimal attention allocation to news in investor utility terms and point out that the optimal attention to news increases in uncertainty in their model. @drake2017 use search volume, analysts forecasts revisions, financial statements downloads and number of news releases to quantify the amount of attention in the cross-sectional comovement sense. The authors argue, that because of limited attention investors focus rather on categories of stocks (e.g. belonging to the same industry), than on individual tickers when it comes to choosing a stock to buy from a large cross-section of stocks. @YUAN2015 investigates the role of market-wide "attention-grabbing" events in capturing investor attention across time. The author points out that the rise in attention level causes investors to make trade decisions.

In the spirit of the studies mentioned above earnings announcements and news arrivals must be a valid indicator of investor attention allocation available on a daily and stock level.

In summary, as proxies for investor attention to particular stocks we employ:

- indicator of firm-specific news arrival at $t$ $news_{i,t}$ 
- number of day-sector specific news at $t$ normalized on the number of firms in the sector, $news\_sector_{i,t}$, and the overall number of news for the whole portfolio arrived at $t$ $news\_day_{i,t}$ 
- indicator of earnings announcements days $ean_{i,t}$ as well as
- indicators of days before and after earnings announcements, $pre\_ean_{i,t}$ and  $post\_ean_{i,t}$. 

The last two together indicate a three-day period around the earnings announcements as in @BERKMAN2009 and the time of news releases. 



**Investor perception**

We infer investor perception using variables which are relevant for risk assessment.
According to @FRIEND1988 the well-known size effect reflects a risk effect and enters therefore our proxy for risk perception. The btm ratios of the previous period, $btm_{i,t-1}$, represents a proxy for performance expectations. Under residual income valuation model @Peasnell1982 connects the value of stocks and the expectation of future abnormal earnings:

\[v_{i,t}= bv_{it} + \sum_{h=1}^\infty \frac1{(1+r)^h}\mathbb E_t(r_{i,t+h}^a)\]

where $v_{i,t}$ is the market value and $bv_{i,t}$ is the book value of  equity $i$, $r_{i,t}^a$ excess returns at $t$ and $r$ is the cost of capital.

\[btm_{i,t} = \frac{bv_{it}}{v_{i,t}}\]

@DONNELLY2014 writes "The intuition is that the prices of growth stocks are much more sensitive to earnings expectations than those of value stocks." and "Accordingly, their prices are more sensitive than value stocks to any earnings surprise regardless of the sign." Therefore, we also include the interaction term between btm ratio $<1$ and post earnings day $(btm_{i,t-1}<1)\cdot post\_ean_{i,t}$ to control for this effect.

According to @BERKMAN2009, the share turnover around earnings announcements can be an indicator of opinion differences and consequently overpriced stocks, which leads to price correction upon information arrival as the authors argue. Therefore, we also control for this effect by including an interaction term between turnover and days earnings announcements indicator $days\_ean_{i,t}$ in our model. The later indicates the announcement date itself, the day before and the day after the earnings announcements as in @BERKMAN2009.

In summary, as proxies for investor perception we use firm specific 

- firm specific size and 
- btm ratios as well as 
- the interaction term between small btm ratio and the post earnings announcements day as well as 
- turnover around earnings announcements.
 
The considered proxies and their assignment to an investor opinion channel is somewhat rudimentary. The effects are interconnected and blurred. Our classification is thus not the only one possible and should just give a sort of a structure for the exploration of the effects. 

**Investor sentiment**

Investor sentiment can be understood as positive or negative polarity as indicated by @FRANKEL2022.
Investor sentiment influences stock prices, which is widely accepted in academia @de1990noise, @TETLOCK2007, @LOUGHRAN2011 and @FRANKEL2022. Now, the question is no longer, as it was a few decades ago, whether investor sentiment affects stock prices, but rather how to measure investor sentiment and quantify its distributional effects.
Several different approaches to measuring sentiment have been proposed, which can be divided into two categories. The first one uses financial proxies to measure sentiment, see @de1990noise, @barberis1998model, @baker2007investor. Candidate methods of measuring sentiment contain earnings per share forecast and earnings surprise. For instance, earnings surprises were useful in @Maheu2004 to proxy investor sentiment. 

The second approach is to calculate sentiment directly from textual documents. There exist two main methods here, a dictionary-based and supervised machine learning sentiment techniques (see e.g. @JEGADEESH2013 for dictionary based methods and @FANG2021 who successfully uses machine learning methods (random forest) to infer textual sentiment). The results of @FANG2021 and @FRANKEL2022 on using non-linear sentiment models suggest a possibly non-linear effect of sentiment which we capture in our expectile model.

In this paper we use the dictionary-based method and calculate sentiment as the sum of the positive words minus the sum of the negative words and then divided by the sum of the positive and negative words. This measure of sentiment is also called net tone, and widely adopted in research and applications. Following prior research, we apply two dictionaries to disclosure sentiment: the Loughran \& McDonald (LM) business-context dictionary and the Harvard (HV) psychosociological dictionary.


Accordingly, we use four sentiment measures: direct assessment via earnings per share as well as earning surprises and indirect inferring of sentiment using LM and HV dictionary based on NASDAQ textual documents.

In summary, as proxies for investor sentiment we use:

- earning per share $eps_{i,t}$
- earnings surprise  $surp_{i,t}$ computed as the relative difference of analysts forecast and reported earnings to reported earnings;
- dictionary-based polarity assessment of firm specific news content with Loughran \& McDonald (LM) word list, $lm_{i,t}$;
- dictionary-based polarity assessment of firm specific news content with Harvard (HV) word list, $hv_{i,t}$;


We normalize the last two sentiment measures to the interval $[-1,1]$.

The considered proxies and their assignment to an investor opinion channel is somewhat rudimentary. The effects are interconnected and blurred. Our classification is thus not the only one possible and should just give a sort of a structure for the exploration of the effects.

Exploratory data analysis provided in Appendix supports our hypothesis that the considered covariates impact location, scale and shape of the conditional return distribution. To capture the effects on the conditional return distribution we represent it through its conditional expectiles. A practical estimator of the heterogeneous effects over the return distribution can be obtained by expectile regression.


# Expectile regression for the panel data of NASDAQ returns

As mentioned in the introduction, conditional expectile extends the associated mean regression and allows to assess the considered effects on the whole distribution of asset returns braking it down to a fine grid of expectiles. That way we are neither constrained to a particular distributional assumption nor to certain conditional moments of the return distribution. In this section we review the general set up of the conditional mean model for the panel data of stock returns and its generalization to conditional expectile regression (ER).

## General model definition

Consider a conditional mean model for the panel data of stock return ($r_{i,t}$) of firm $i$ at time $t$ with $i=1,\ldots,n$ and $t=1,\ldots, T$:
\[r_{i,t} = \beta_0 + x_{i,t}^\top\beta + z_{i}^\top\gamma + u_{i} + \varepsilon_{i,t}\]

with response $r_{i,t}$ being the excess return of stock $i$ at time $t$ computed as specified in Section "Data". $x_{i,t}$ a vector of $p$ time varying predictors, and $z_i$ a vector of $n$ time-invariant covariates for the stock $i$ known at time $t$ where $\{{\bf x_{i}},z_i,{\bf r_{i}}\}_{i=1}^N$ are independent und identically distributed.$u_i$ are unobserved firm specific random effects with finite second moments and $\mathbb E(u_i|x_{i,t},z_i)=0$ for all $i$ and $t$, and $\varepsilon_{i,t}$ are idiosyncratic error terms with finite second moments and $\mathbb E(\varepsilon_{i,t}|x_{i,t},z_i,u_i)=0$  for all $i$ and $t$.

The model can be rewritten as:

\[r_{i,t} = \beta_0 + x_{i,t}^\top\beta + z_{i}^\top\gamma+v_{i,t}.\]

where $v_{i,t} = u_{i} + \varepsilon_{it}$.

The conditional expectile regression of @Newey1987 aims at finding the conditional expectile (given the covariates $x_{i,t}$ and $z_i$):

\[e_{\tau,t}(r_{i,t})\equiv e_\tau(r_{i,t}|x_{i,t},z_i) = x_{i,t}^\top \beta_\tau + z_{i}^\top \gamma_\tau, i=1,\ldots, n, t=1,\ldots T,\]

or in terms of the responses $r_{i,t}$:

\[r_{i,t} = x_{i,t}^\top \beta_\tau + z_{i}^\top \gamma_\tau + v_{\tau,i,t}\]

where $v_{\tau,i,t}$ is the error term with $e_\tau(v_{\tau,i,t}|x_{i,t},z_i)=0$ and $\tau\in (0,1)$ is the expectile level which specifies the desired "extremeness" level as @Kneib2013.

The related estimator minimizes the expectile loss function:

\[\arg\min_{\beta\in\mathbb R^p}\frac 1n\sum_{i=1}^n\sum_{t=1}^T\rho_\tau\Big(r_{i,t} - x_{i,t}\beta_\tau - z_i\gamma_{\tau}\Big)\]

with $\rho_\tau(y)=|\tau - \mathbf 1(y<0)|y^2$ is the expectile check function.

The resulting estimator has the form:
\[\hat\theta_\tau =\begin{pmatrix}\hat\beta_\tau\\ \hat\gamma_\tau\end{pmatrix} = \Big(\sum_{i=1}^n\sum_{t=1}^T\hat w_{i,t} (\tau)(x_{i,t}, z_i)(x_{i,t}, z_i)^\top\Big)^{-1}\Big(\sum_{i=1}^n\sum_{t=1}^T\hat w_{i,t} (\tau)(x_{i,t}, z_i)r_{i,t}\Big)\]

with $\hat w_{i,t}(\tau) = |\tau - \mathbf 1(r_{i,t}\leq x_{i,t}\hat\beta_\tau + z_i\hat\gamma_\tau)|$

and can be computed via iterative weighted asymmetric least squares as proposed by @Newey1987 on pooled data.

@BARRY2016 show asymptotic normality of the estimator under mild assumptions:

\[\sqrt{n}(\hat \theta_\tau - \theta_\tau)\rightarrow \mathcal N(0,H^{-1}\Sigma H^{-1})\]

The variances-covariances matrix of the estimator can be estimated via:

\[\hat H=X^\top\hat W X/n, \text{where } \hat W = diag(\hat w_{1,1}(\tau),\ldots,\hat w_{n,T})\]

and \[\hat \Sigma = X^\top\hat W\hat\varepsilon\hat \varepsilon^\top\hat WX/n\] with $X=\{(x_{i,t},z_i)^\top\}_{i=1,\ldots,n, t=1,\ldots,T}$.

We compute robust standard errors for the ER-coefficients with R-Package sandwich (@Zeileis2020) allowing for heteroscedastic and serial errors.

## Estimation results for expectile regression with proxies of investor opinion

We use the conditional linear expectile model defined above for estimating the effects of investor opinion channels on NASDAQ the individual conditional expectiles of abnormal returns $e_{\tau,t}(r_{i,t})$. Our model specification is therefore:

\begin{align}
e_{\tau,t}(r_{i,t}) = &\beta_{0,\tau}+\beta_{1,\tau}\cdot pre\_ean_{i,t} + \beta_{2,\tau}\cdot ean_{i,t} + \beta_{3,\tau}\cdot post\_ean + \beta_{4,\tau}\cdot news_{i,t} +\beta_{5,\tau}\cdot news\_sector_{i,t} + \beta_{6,\tau}\cdot news\_day_{i,t} \\
& + \beta_{7,\tau}\cdot \log(size_{i,t}) + \beta_{8,\tau} \cdot btm_{i,t-1} + \beta_{9,\tau}\cdot days\_ean_{i,t}\cdot turn_{i,t-1}+ \beta_{10,\tau}\cdot (btm_{i,t-1}<1)\cdot ean_{i,t}\\
& + \beta_{11,\tau}\cdot eps_{i,t}  + \beta_{12,\tau}\cdot surp_{i,t} + \beta_{13,\tau}\cdot lm\_tone_{i,t} + \beta_{14,\tau}\cdot hv\_tone_{i,t} + \gamma_{1,\tau}^{\top}\cdot sector_{i}+ \gamma_{2,\tau}^\top\cdot firm_{i}(\#eq:mod0)
\end{align}

 with
 
 - $r_{i,t}$ the abnormal return of stock $i$ at time $t$,
 
 - $pre_ean_{i,t}$ indicator the day before an earnings announcement referred to company $i$, 
 
 - $ean_{i,t}$ indicator whether an earnings announcement referred to company $i$ has been released at $t$,
 
 - $post_ean_{i,t}$ indicator the day after an earnings announcement referred to company $i$,
 
 - $news_{i,t}$ indicator whether a news report referred to company $i$ has been released at $t$,
 
 - $news\_sector_{i,t}$ number of news reports  at $t$ for the company $i$ sector normalized to sector size, 
 
 - $news\_day_{i,t}$ number of news reports  at $t$ for all companies in portfolio normalized to portfolio size, 
 
 - $\log(size_{i,t})$ the logarithm of the size? of the company, 
 
 - $btm_{i,t-1}$ the book-to-market ratio of company $i$ in $t-1$,
 
 - $turn_{i,t-1}$ share turnover of company $i$ in $t-1$,
 
 - $days_ean_{i,t}$ indicator a three-day period around an earnings announcement referred to company $i$, 
 
 - $eps_{i,t}$ reported earnings per share for company $i$ in $t$,
 
 - $surp_{i,t}$ earnings surprise in $\%$ at $t$ according to an earnings announcement and analysts forecast referred to company $i$,
 
 - $lm\_tone_{i,t}$ and $hv\_tone_{i,t}$ are news polarity or sentiment measures obtained by using LM and HV dictionary respectively. These measures are computed as $\frac{\#\text{ of positive words} - \# \text{ of negative words}}{\#\text{ of positive words}+\# \text{ of negative words}}$ using the corresponding dictionary.
 
<!-- - $ml\_tone_{i,t}$ out-of-sample return forecast obtained using random forest with news content as explanatory variable.-->
 
 - $sector_{i}$ and $firm_{i}$ are the associated sector/firm dummy variables of the form $(0,0,\ldots,0,1,0,\ldots,0)$.
 

Within our model, we control for the effects of investor attention ($\beta_1$ to $\beta_6$), for the effects of investor perception ($\beta_7$ to $\beta_{10}$), as well as the effects of investor sentiment ($\beta_{11}$ to $\beta_{14}$).
 
We fit the models as specified in Equation \@ref(eq:mod0) for $\tau\in\{0.05,0.1,\ldots,0.95\}$ and show the resulting coefficients, their significance (based on robust standard errors) and the associated $R^2$ in Table \@ref(tab:table1) and \@ref(tab:table11).

```{r,echo=FALSE}

ind_use<-which(!is.na(data$btm1))
formul<-as.formula("r_.ab.~ pre_ean+ean+post_ean+news+news_sector+news_day+log(Size)+ btm1 + I(turnover1*days_ean)+ I((btm1<1)*post_ean) + surprise + LM.TONE + HIV4.TONE +Sector+Ticker")

taus_mod<-c(0.005,0.01,seq(0.05,0.95,by=0.05),0.99,0.995)
library(tictoc)
tic()
mod0<-fit_eeffects(formul=formul,dat=data[ind_use,],taus=taus_mod,ses=T)
toc()

# save(mod0, file="mods/mod0.RData")
# load("mods/mod0.RData")
taus_mod<-c(0.005,0.01,seq(0.05,0.95,by=0.05),0.99,0.995)
ind_use<-which(!is.na(data$btm1))
```


```{r table1,echo=FALSE}
#mod0[[1]]

##lower expectiles
which_tau=c(2:4,seq(6,12,by=2))
make_knitr_table_all(mod0, which_tau=which_tau,taus=taus_mod, which_ones = 1:14,
                     #row.names=NA
                     row.names=c("Constant","pre_ean_{i,t}","ean_{i,t}","post_ean_{i,t}",
                                 "news_{i,t}","news_sector_{i,t}",  "news_day_{i,t}", 
                                 "log(size_{i,t})","btm_{i,t-1}", "turn_{i,t-1}*days_ean_{i,t}",
                                 "(btm_{i,t-1}< 1)*post_ean_{i,t}","supr_{i,t}",
                                 "lm_tone_{i,t}", "hv_tone_{i,t}",
                                 "R^2")
                     )



```


```{r table11,echo=FALSE}

#higher expectiles
which_tau=c(seq(12,20,by=2),21,22)
make_knitr_table_all(mod0, which_tau=which_tau,taus=taus_mod, which_ones = 1:14,
                     #row.names=NA
                     row.names=c("Constant","pre_ean_{i,t}","ean_{i,t}","post_ean_{i,t}",
                                 "news_{i,t}","news_sector_{i,t}",  "news_day_{i,t}", 
                                 "log(size_{i,t})","btm_{i,t-1}", "turn_{i,t-1}*days_ean_{i,t}",
                                 "(btm_{i,t-1}< 1)*post_ean_{i,t}","supr_{i,t}",
                                 "lm_tone_{i,t}", "hv_tone_{i,t}",
                                 "R^2")
                     )

```

As reported in \@ref(tab:table1), many of the effects are insignificant for the conditional mean return ($\tau=0.5$) but become significant for the conditional $\tau$-expectiles with $\tau\not=0.5$. That is, higher moments of the conditional distribution are affected by the considered investment opinion channel proxies. Also, the explained weighted variance proportion becomes higher in the tails of the conditional return distribution. Moreover, some of the effects appear to be significant only for lower ($(btm_{i,t-1}<1)\cdot post\_ean_{i,t}$, $surp_{i,t}$and $hv_tone_{i,t}$) and some - only for higher expectiles  ($turn_{i,t}\cdot days\_ean_{i,t}$, $\log(size_{i,t})$).


In the next figure, we plot the attention related effects with $95\%$-CI in Figure \@ref(fig:figure1) across the $\tau$-values:

```{r figure1, fig.cap="Coefficient profiles of the investor attention related variables for different $\\tau$-levels", echo=FALSE}
          
lbls<-c(bquote(pre_ean[it]),bquote(ean[it]),bquote(post_ean[it]),bquote(news[it]),bquote(news_day[it]))
al<-0.95

wo<-c("pre_ean","ean","news","news_day")

plot_eefects(mod0,which_ones=wo,which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),lbls=lbls[c(1:2, 4:5)],sc=c(2,2,1,1),cex.axis=0.7,las=1)

```

Note that the effects of $ean_{i,t}$ and $news_{i,t}$ are negative for low expectiles and become positive for higher $\tau$-levels. Thus, these events tend to increase the dispersion in returns by "pushing" their expectiles apart. For the effect of $pre\_ean_{i,t}$ the opposite holds. However, the overall effect absorbs also the reversed contribution of $turn_{i,t}\cdot days\_ean_{i,t}$, such that both reduction and increase of dispersion are conceivable. The coefficient profile of $news\_day$ exhibits significant negative impact on lower expectiles producing a potential source of negative skewness in return distribution.


Figure \@ref(fig:figure2) shows the effects related to investor perception with $95\%$-CI. Also here, higher values of $btm$ and $turn \cdot days\_ean$ induce a higher expectile spread and consecutively higher dispersion. The negative influence of $btm<1\cdot post_ean$ and $log(size)$ is one-sided directed on either low or high expectiles.

```{r figure2, fig.cap="Coefficient profiles of the investor perception related variables for different $\\tau$-levels", echo=FALSE}
     
lbls<-c(bquote(btm[it-1]),bquote(log(size)[it]),bquote(turn[it-1]*days_ean[it]),bquote((btm[it-1]<1)*post_ean[it])
)
al<-0.95
wo<-c("btm1","log(Size)","I(turnover1 * days_ean)","I((btm1 < 1) * post_ean)")

plot_eefects(mod0,which_ones=wo,which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),lbls=lbls[1:length(wo)],
             sc=c(1,1,1,5),cex.axis=0.7,las=c(1))

```

Finally, in Figure \@ref(fig:figure3) we plot the effects related to investor sentiment with $95\%$-CI.
Overall, significant sentiment effects are all positive, as a result, the sign of the sentiment tone determines the expected direction of the conditional return reaction. Whereas, $lm\_tone$ tend to shift the whole distribution, $surp$, $hv\_tone$ and $eps$ show significant impact primary on lower expectiles.

```{r figure3, fig.cap="Coefficient profiles of the investor sentiment related variables for different $\\tau$-levels", echo=FALSE}
        
lbls<-c(bquote(surp[it]),bquote(lm_tone[it]),bquote(hv_tone[it]), bquote(eps[it]),
        bquote(lm_tone[it-1]),bquote(hv_tone[it-1]), 
       bquote(ml_tone[it])
)
al<-0.95
#summary(mod0[[1]])
wo<-c("surprise","LM.TONE","HIV4.TONE")#, "eps")#,"ML.TONE")

plot_eefects(mod0,which_ones=wo,which_tau=which(taus_mod%in%seq(0.05,0.95,0.05)),lbls=lbls[1:length(wo)],
             special=cbind(c(0,0,-0.005,-0.001),c(0.1,0.004,0.01,0.005)),sc=c(1,1,1,1),cex.axis=0.7,las=1)

```

The effect of news releases is positive for higher expectiles and is sharpened by the sign of the associated sentiment tone. Simultaneously, we observe a strongly negative effect of news arrivals for low return expectiles regardless of the news tone. That is, also positive news expand the gap between return expectiles and increases thus the dispersion of  associated abnormal returns. This effect can be connected to the 'sidedness' of @SARKAR2009 where the disproportionaly higher seller or buyer quote at news arrivals.

In summary, some of the effects such as $pre_ean$, $ean$, $news$, $btm$, and $turn\cdot days\_ean$ impact both higher and lower expectiles with opposite effects (negative versus positive). As a result, they have a "widening" effect on the distribution as expectiles below and above the mean are pushed apart. $lm\_tone$ shifts all expectiles either to the right or to the left depending on the sign of the tone. Other considered effects are one-sided and change either the right or the left tail of the return distribution. We explore the resulting changes in the distribution shape regarding its dispersion and skewness as well as tail measures in the next section.

# Quantifying the effects on the shape of the return distribution

## Expectile-based dispertion and skewness measures

The estimated the conditional expectile models facilitate comparison of the resulting impact on the distribution via expectile-based measures. One useful concept - *interexpectile difference* (or range) was introduced in financial context by @bellini2018 to measure variability of a risk-neutral distribution. Their interexpectile difference for a random variable $X$ with a finite expectation $\mathbb E(X)$ is defined as:

\[\Delta_\tau = e_{1-\tau}(X) - e_\tau(X)\]

for $\tau\in(0,0.5).$

The authors show that the proposed measure is consistent with the convex order. Recently, @eberl2022 demonstrate that empirical interexpectile range is more efficient than the classical standard deviation for skewed and long-tailed distributions. Moreover, a class of expectile-based measures of skewness was proposed in @eberl2022sk. For comparison here, we use their $s_{2\tau}$ (denoted further as $s_\tau$) defined as:

\[s_{\tau} = \frac 1{1-2\tau}\cdot\frac{e_{1-\tau}(X) + e_\tau(X) - 2\mathbb E(X)}{e_{1-\tau}(X) - e_\tau(X)}\]

for $\tau\in(0,0.5).$ This skewness measure is normalized to $(-1,1)$ and property $s_2(\tau)\geq 0$ ($s_2(\tau)\leq 0$) holds whenever $\tau\in(0,0.5)$ and the distribution is right-skewed (left-skewed).

We take $\tau=0.1$ for our analysis which are also used in @eberl2022sk and consider the straight forward adjustment for our conditional expectile regression setup of the model in \@ref(eq:mod0). In our case, the conditional interexpectile range becomes for $\tau=0.1$:
\[\Delta_{0.1,i,t} = e_{0.9,t}(r_{i,t}) -  e_{0.1,t}(r_{i,t}) = x_{i,t}^\top (\beta_{0.9} - \beta_{0.1}) + z_i^\top(\gamma_{0.9} - \gamma_{0.1})\]
where $x_{i,t}$ is a vector of the time-varying firm characteristics from \@ref(eq:mod0) and $z_i$ is a vector of firm characteristics which do not change over time. Similar, the conditional expectile-based skewness measure $\hat s_{\tau,i,t}$ is for $\tau=0.1$:
\begin{align*}s_{0.1,i,t} &= \frac 1{1-2\cdot0.1}\cdot\frac{e_{0.9,t}(r_{i,t}) + e_{0.1,t}(r_{i,t}) - 2e_{0.5,t}(r_{i,t})}{\Delta_{0.1,i,t}}\\
&=1.25\cdot\frac{x_{i,t}^\top (\beta_{0.9} + \beta_{0.1} - 2\beta_{0.5}) + z_i^\top(\gamma_{0.9} + \gamma_{0.1} - 2\gamma_{0.5})}{x_{i,t}^\top (\beta_{0.9} - \beta_{0.1}) + z_i^\top(\gamma_{0.9} - \gamma_{0.1})}.
\end{align*}

Pluggin in the estimator for the parameters, we obtain the estimators for the conditional interexpectile range:
\[\hat\Delta_{0.1,i,t} = x_{i,t}^\top (\hat\beta_{0.9} - \hat\beta_{0.1}) + z_i^\top(\hat\gamma_{0.9} - \hat\gamma_{0.1})\]
as well as for the conditional expectile-based skewness measure $\hat s_{\tau,i,t}$:
\begin{align*}\hat s_{0.1,i,t} &= 1.25\cdot\frac{x_{i,t}^\top (\hat\beta_{0.9} + \hat\beta_{0.1} - 2\hat\beta_{0.5}) + z_i^\top(\hat\gamma_{0.9} + \hat\gamma_{0.1} - 2\hat\gamma_{0.5})}{x_{i,t}^\top (\hat\beta_{0.9} - \hat\beta_{0.1}) + z_i^\top(\hat\gamma_{0.9} - \hat\gamma_{0.1})}
\end{align*}

For each firm and each period, we compute $\hat\Delta_{0.1,i,t}$ and $\hat s_{0.1,i,t}$. Then, we average the resulting values considering time indices $t$, at which different events occur, separately. The resulting means are denoted as $\overline\Delta_{0.1}^{no~event}$, $\overline\Delta_{0.1}^{event}$, and $\overline s_{0.1}^{event}$. The associated relative changes in the interexpectile ranges for particular events result from normalizing to the case of no events, $\overline\Delta^{event}_{0.1}/\overline\Delta^{no~event}_{0.1}$ and are provided in Table \@ref(tab:tabdelt1). 


```{r, echo=F}
taus_delta<-c(0.1)

ind_sets<-cbind(sapply(taus_delta,function(x){which(as.character(taus_mod)==x)}),
                sapply(1-taus_delta,function(x){which(as.character(taus_mod)==x)})) # 0.1, 0.25, 0.4
delta<-sk<-etau<-e1_tau<-e0.5<-matrix(NA,length(ind_use),nrow(ind_sets))
colnames(delta)<-paste0("tau_",taus_delta)
for(i in 1:nrow(ind_sets)){
  #predict the exp
  etau[,i]<-suppressWarnings(predict(mod0$mods[[ind_sets[i,1]]],data[ind_use,]))
  e1_tau[,i]<-suppressWarnings(predict(mod0$mods[[ind_sets[i,2]]],data[ind_use,]))
  e0.5[,i]<-suppressWarnings(predict(mod0$mods[[12]],data[ind_use,]))
  #compute the pars
  delta[,i]<-e1_tau-etau
  sk[,i]<-1/(1-2*taus_delta[i])*(e1_tau+etau - 2*e0.5)/delta[,i]
}
data$delta<- data$sk<-data$etau<-data$e1_tau<-data$e0.5<-NA
data$delta[ind_use]<-delta; data$sk[ind_use]<-sk; data$etau[ind_use]<-etau; 
data$e1_tau[ind_use]<-e1_tau; data$e0.5[ind_use]<-e0.5

df_agg_len<-aggregate(delta~type2,data,length)

df_agg<-cbind(aggregate(delta~type2,data,mean), skew=aggregate(sk~type2,data,mean)[,2])
colnames(df_agg)<-c("type2","delta","skew")

df_agg<-transform(df_agg,change=delta/delta[type2=="noevent"])
df_agg<-df_agg[order(df_agg$change),]
df_agg<-df_agg[,c(1,2,4,3)]

```


We observe a substantial increase in dispersion on earnings announcement and subsequent days. News releases have a more subtle impact but still enhance the increase in dispersion of about 1/4 on average. The slight increase of the dispersion on the days before earnings announcements is grounded on the interplay of the effects of $pre_ean$ and $turn*days_ean$. The later effect is according to @BERKMAN2009 to trace back to the difference of opinions on the expected performance for some firms.


```{r, echo=FALSE}
### bootstrapping the confidence intervals for expectile range and skewness
# bootstrap preparation

#T
dates<-unique(data$Date)
period<-60
periods_start<-seq(1,length(dates)-period,by=period)

blocksT<-list(0)

for(i in 1:length(periods_start)){
  blocksT[[i]]<-dates[seq(periods_start[i], by=1, length.out=period)]
}

#N
individs<-unique(data$Ticker)



#params
target_taus<-c(0.1,0.25,0.4,0.5,0.6,0.75,0.9)
#formul<-as.formula("r_.ab.~ pre_ean+ean+post_ean+news+news_sector+news_day+log(Size)+ btm1  + I(turnover1*days_ean)+ I((btm1<1)*post_ean) +I(surprise*100) + LM.TONE + HIV4.TONE + Sector+Ticker")


#boot size
B<-100


#placeholders
etaub<-e1_taub<-e0.5b<-Fetaub<-Fe1_taub<-Fe0.5<-matrix(NA,nrow(df_agg),B)
etaubs<-e1_taubs<-Fetaubs<-Fe1_taubs<-list(1:length(target_taus))
ier0.1<-ier0.25<-ier0.4<-sk0.1<-sk0.25<-sk0.4<-data.frame(type2=df_agg$type2)
Fes<-NULL
```


```{r, echo=FALSE}
for(bb in seq(1,1000,100)){
  BB=bb+99
  print(bb)
  for (b in 1:B){
    cat("\f")
    print(paste0("bb=",bb,"b=",b))
    #tic()
    set.seed(123+bb+b)
    ############bootstrap
    #T
    bootT<-sample.int(length(blocksT),replace=T)
    dataBoot<-NULL
    for(i in bootT){
      dataBoot<-rbind(dataBoot,data[data$Date%in%blocksT[[i]],])
    }
    #N
    indiv<-individs[sample.int(length(individs),replace=T)]
    dataBootTN<-NULL
    for(i in 1:length(indiv)){
      dataBootTN<-rbind(dataBootTN,dataBoot[dataBoot$Ticker==indiv[i],])
    }
    dataBootTN<-data.frame(dataBootTN)
    dataBootTN<-transform(dataBootTN,ier0.1=NA,ier0.25=NA,ier0.4=NA,sk0.1=NA,sk0.25=NA,sk0.4=NA)

    ###############estimate tau(alpha)
    ind_use<-which(!is.na(dataBootTN$btm1))
    mod_b<-fit_eeffects(formul=formul,dat=dataBootTN[ind_use,],taus=target_taus,ses=F)
    #predicted expectiles
    e_taus_f<-unlist(lapply(mod_b$mods,fitted)); e_taus_f<-matrix(e_taus_f,,length(mod_b$mods))
    #stats ier and sk
    dataBootTN[ind_use,c("ier0.1","ier0.25","ier0.4")]<--cbind(e_taus_f[,1]-e_taus_f[,ncol(e_taus_f)],
                                                              e_taus_f[,2]-e_taus_f[,(ncol(e_taus_f)-1)],
                                                              e_taus_f[,3]-e_taus_f[,(ncol(e_taus_f)-2)])
    dataBootTN[ind_use,c("sk0.1","sk0.25","sk0.4")]<-cbind(
      1/(1-2*0.1)*(e_taus_f[,ncol(e_taus_f)]+e_taus_f[,1]-2*e_taus_f[,4])/(e_taus_f[,ncol(e_taus_f)]-e_taus_f[,1]),
      1/(1-2*0.25)*(e_taus_f[,(ncol(e_taus_f)-1)]+e_taus_f[,2]-2*e_taus_f[,4])/(e_taus_f[,(ncol(e_taus_f)-1)]-e_taus_f[,2]),
       1/(1-2*0.4)*(e_taus_f[,(ncol(e_taus_f)-2)]+e_taus_f[,3]-2*e_taus_f[,4])/(e_taus_f[,(ncol(e_taus_f)-2)]-e_taus_f[,3])
    )
    #stats summary for events
    suppressWarnings({ ier0.1<-merge(ier0.1,aggregate(ier0.1~type2,dataBootTN,mean),by.x="type2",by.y="type2",all.x=T)
    ier0.25<-merge(ier0.25,aggregate(ier0.25~type2,dataBootTN,mean),by.x="type2",by.y="type2",all.x=T)
    ier0.4<-merge(ier0.4,aggregate(ier0.4~type2,dataBootTN,mean),by.x="type2",by.y="type2",all.x=T)
    sk0.1<-merge(sk0.1,aggregate(sk0.1~type2,dataBootTN,mean),by.x="type2",by.y="type2",all.x=T)
    sk0.25<-merge(sk0.25,aggregate(sk0.25~type2,dataBootTN,mean),by.x="type2",by.y="type2",all.x=T)
    sk0.4<-merge(sk0.4,aggregate(sk0.4~type2,dataBootTN,mean),by.x="type2",by.y="type2",all.x=T)
    })
    Fes<-rbind(Fes,apply(e_taus_f,2,function(q,x){sum(x<q)},x=dataBootTN$r_.ab.[ind_use])/length(dataBootTN$r_.ab.[ind_use]))
    #toc()
  }
  stats<-list(ier0.1,ier0.25,ier0.4,sk0.1,sk0.25,sk0.4,Fes)
  #save(stats,file="stats.RData")
}

```


```{r,echo=F}
#load("stats.RData")
ier0.1<-stats[[1]]; ier0.25<-stats[[2]]; ier0.4<-stats[[3]] 
sk0.1<-stats[[4]]; sk0.25<-stats[[5]]; sk0.4<-stats[[6]];

```

```{r,echo=F}
compute_diff<-function(df,relrow="noevent"){
  ind<-which(df[,1]==relrow)
  relx<-as.numeric(df[ind,-1])
  dfm<-as.matrix(df[-ind,-1]) - matrix(relx,nrow(df)-1,length(relx),byrow = T)
  dfm<-data.frame(type2=df$type2[-ind],dfm)
  return(dfm)
}
compute_sign<-function(df,levels=c(0.001,0.01,0.05,0.1),two_sided=T){
  dfm<-as.matrix(df[,-1])
  if(two_sided){
    levels=levels/2
  }
  qs_low<-t(apply(dfm,1,quantile,probs=levels))
  qs_high<-t(apply(dfm,1,quantile,probs=1-levels))
  signs<-sign(qs_low)*sign(qs_high)
  stars<-rep(NA,dim(dfm)[1])
  stars[signs[,1]>0]<-"***"; stars[is.na(stars)&signs[,2]>0]<-"**"; stars[is.na(stars)&signs[,3]>0]<-"*"; stars[is.na(stars)&signs[,4]>0]<-"°"
  stars[is.na(stars)]<-""
  return(stars)
}


diff0.1<-compute_diff(df=ier0.1)
diff0.25<-compute_diff(df=ier0.25)
diff0.4<-compute_diff(df=ier0.4)

sign0.1<-compute_sign(diff0.1)
sign0.25<-compute_sign(diff0.25)
sign0.4<-compute_sign(diff0.4)

sign_sk0.1<-compute_sign(sk0.1,two_sided=F)
sign_sk0.25<-compute_sign(sk0.25,two_sided=F)
sign_sk0.4<-compute_sign(sk0.25,two_sided=F)

df_agg<-transform(df_agg,delta=paste0(round(delta,4), paste0("(",round(delta-delta[1],4)),c("",sign0.1[match(df_agg$type2[-1],diff0.1$type2)]),")"))
df_agg$skew<-paste0(round(df_agg$skew,4), sign_sk0.1[match(df_agg$type2,sk0.1$type2)])

```

```{r, tabdelt1, echo=F}
caption<-"Mean boostrapped interexpectile ranges $\\overline\\Delta^{event}_{0.1}$ and mean boostrapped expectile-based skewness $\\hat s_{0.1}$ on event days. The increases in the dispersion associated with $\\overline\\Delta^{event}_{0.1}$ compared to the case of no event ($\\overline\\Delta^{event}_{0.1}-\\overline\\Delta^{no~event}_{0.1}$) are given in brackets.  Symbols '***','**','*','°' indicate significance on 0.1\\%, 1\\%, 5\\% level respectively obtained based on bootstrap."

 knitr::kable(df_agg, align = "lll",
               col.names = colnames(df_agg),
               row.names = F,
               digits = 4,
               caption = caption
  )
```

Overall, we find a weak evidence that unscheduled information arrivals in form of news releases induce positive/negative skewness of the return distribution when textual news polarity is positive/negative.
 
## Tail effects: investor opinion and expected shortfall

A frequently used risk measure is the $\alpha$-expected shortfall, denoted as $ES_{\alpha}$. It is connected to the quantile $q_\alpha$ of the target distribution. For the lower tail of the later this risk measure is defined as  $ES_\alpha = \mathbb E(Y|Y<q_\alpha)$. 

@JONES1994 shows that there is a one-to-one correspondence between quantiles and expectiles of a distribution. Based thereof, @Taylor2008 proposes to use expectiles to estimate $ES_{\alpha}$ with $\alpha\leq 0.5$ via:

\begin{align}
ES_{\alpha} &= \left(1+\frac{\tau}{(1-2\tau)\alpha}\right)e_{\tau} - \frac{\tau}{(1-2\tau)\alpha}e_{0.5},
\end{align}

where $\alpha\in(0,0.5]$ denotes the quantile level, $\tau\in(0,1)$ is the associated expectile level, and $e_{\tau}$ is the respective expectile. As @Taylor2008, the same relation holds for the conditional expected shortfall with respect to the conditional expectile.

@yao1996 show the existence of a bijective function $\tau:(0,1)\rightarrow (0,1)$  which connects the quantile level $\alpha$ to the expectile level $\tau$ such that $q_\alpha = e_{\tau(\alpha)}$.

Thus, if the relation $\hat\tau(\alpha)$ or its estimate $\hat \tau(\alpha)$ is available, a plug-in estimator for the expected conditional shortfall based on the estimated conditional expectile analog to the autoregressive version in @Taylor2008 can be obtained:

\begin{align}
ES_{\alpha}(r_{i,t}|x_{i,t},z_i) &= \left(1+\frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}\right)e_{\hat\tau(\alpha)}(r_{i,t}|x_{i,t},z_i) - \frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}e_{0.5}(r_{i,t}|x_{i,t},z_i)\nonumber\\
&=\tilde \beta_{0,\alpha} + \tilde\beta_{\alpha}^\top \cdot x_{i,t} + \tilde\gamma_\alpha^\top\cdot z_i,(\#eq:es)
\end{align}

with


\begin{align}
\tilde\beta_\alpha &= \hat \beta_{\hat\tau(\alpha)} - \frac{\hat\tau(\alpha)}{\big(1-2\hat\tau(\alpha)\big)\alpha}\cdot \left(\hat\beta_{0.5} -\hat \beta_{\hat\tau(\alpha)}\right).(\#eq:tbeta)
\end{align}


and $\tilde\beta_0$ and $\tilde\gamma$ are defined analogous.

To obtain the actual estimates, we first estimate the conditional expectile model as in \@ref(eq:mod0) for a fine grid of $\tau = 0.001, 0.0025, 0.005,0.01,0.02,\ldots, 0.1$. Following @Taylor2008, we construct an empirical cumulative distribution function by counting the observations below the estimated expectile profile for each of the $\tau$-levels, such that for each $\tau$ we have the corresponding quantile index $\alpha$. We then interpolate linearly between the resulting points to obtain $\hat\tau(\alpha)$ particular for $\alpha\in\{0.01,0.05,0.1\}$. The estimated correspondence is plotted in Figure \@ref(fig:figure4).


```{r, echo=FALSE}
ind_use<-which(!is.na(data$btm1))
formul<-as.formula("r_.ab.~ pre_ean+ean+post_ean+news+news_sector+news_day+log(Size)+ btm1 + I(turnover1*days_ean)+ I((btm1<1)*post_ean) +surprise + LM.TONE + HIV4.TONE +Sector+Ticker")
# for a range of tau values compute the expectile
taus_f<-c(0.001,0.0025,0.005,0.01,seq(0.01,0.08,0.01))
mod_f<-fit_eeffects(formul=formul,dat=data[ind_use,],taus=taus_f,ses=F)
#save(mod_f, file="mod_f.RData")
e_taus_f<-unlist(lapply(mod_f$mods,fitted)); e_taus_f<-matrix(e_taus_f,,length(mod_f$mods))
alphas_f<-apply(e_taus_f,2,function(q,x){sum(x<q)}, x=data$r_.ab.[ind_use])/length(data$r_.ab.[ind_use])

tau_alpha<-cbind(taus_f,alphas_f)
colnames(tau_alpha) = c("tau","alpha")

#save(tau_alpha, file="tau_alpha.RData")
#-------------------------------------------------------

#linear interpolation
tau_new = approx(tau_alpha[,2], tau_alpha[,1], xout=c(0.01,0.05,0.1))
#new model for the target tau
mod_new<-fit_eeffects(formul=formul,dat=data[ind_use,],taus=c(tau_new$y,0.5),ses=F)
#save(mod_new, file="mods/mod_new.RData")

#load("tau_alpha.RData")
tau_new = approx(tau_alpha[,2], tau_alpha[,1], xout=c(0.01,0.05,0.1))
#load("mods/mod_new.RData")
```


For instance, in our model specification the lower quantile levels $\alpha\in\{0.01,0.05,0.1\}$ correspond to the expectile levels $\tau\in\{`r paste(round(tau_new[[2]],4), collapse=",")`\}$ respectively.

```{r,figure4, fig.cap="The estimated relation between the expectile level $\\tau$ (vertical axis) and the quantile level $\\alpha$ (horizontal axis) for the empirical distribution of the considered abnormal NASDAQ returns.", echo=FALSE}
plot(tau_alpha[,2],tau_alpha[,1], type="l",ylim=c(0,0.11),xlim=c(0,0.15), ylab=bquote(tau), xlab=bquote(alpha), axes=F)

points(tau_new$x,tau_new$y,col=2, pch=16)
axis(1, at=c(0,0.01,0.05,0.1,0.15), labels=c(0,0.01,0.05,0.1,0.15))
axis(2, las=1, at=c(0,0.05,0.1), labels=c(0,0.05,0.1))
par(xpd=T)

arrows(c(0.01,0.05,0.1),rep(-0.004,3),tau_new$x,tau_new$y, col=2, lty=2,code=0)
arrows(rep(-0.005,3), tau_new$y, tau_new$x,tau_new$y,col=2, lty=2,code=0)

text(-0.012, tau_new$y[1]+0.002, round(tau_new$y[1],4),cex=0.7,col=2)
text(-0.012, tau_new$y[2]+0.002, round(tau_new$y[2],4),cex=0.7,col=2)
text(-0.012, tau_new$y[3]+0.002, round(tau_new$y[3],4),cex=0.7,col=2)

```


For the target $\alpha\in\{0.01,0.05,0.1\}$ we compute the resulting coefficients $\tilde\beta_\alpha$ which stand for the investor opinion effects on the conditional expected shortfall. The associated $95\%$ confidence intervals are obtained by cross-sectional and temporal bootstrap as defined in @Kapetanios2008 using $1000$ bootstrap draws. To preserve the possible serial dependence structure we use block bootstrap for the time-series dimension with block length of $60$. 

```{r, echo=FALSE}
lcoef<-15#number of variables for the coefficient table
target_alphas<-c(0.01,0.05,0.1)
which_ones=(1:(lcoef))
tbeta0<-list(0)
for(j in 1:length(target_alphas)){
     tbeta0[[j]]<-mod_new$coefs[which_ones,j] -
       tau_new$y[j]/((1-2*tau_new$y[j])*target_alphas[j])*(mod_new$coefs[which_ones,ncol(mod_new$coefs)]-mod_new$coefs[which_ones,j])
   }
```


The bootstrapping is carried out as follows. For each bootstrap draw $b=1,\ldots, B$, we, first, estimate the ER model for a fine grid of $\tau$-values in the left tail $0.001,0.0025,0.005,0.01,0.02,\ldots,0.1$. Then using the fitted conditional expectiles, we estimate the correspondence $\hat\tau^{(b)}(\alpha)$ by assigning to each $\tau$-value the proportion of observations $\alpha$ in the bootstrap sample lying below the expectile profile $\{e_{tau}(r^{(b)}_{it})\}_{i=1,t=1}^{N,T}$. By interpolating linearly between the points, we determine the needed $\tau$-levels for the target $\alpha$-levels of $0.01,0.05,0.1$. The estimated $\hat\tau(\alpha)$ with $95\%$ bootstrap confidence intervals is presented in Figure \@ref(fig:figure5).

Finally, we compute $\tilde\beta^{(b)}_\alpha$ for each bootstrap sample as specified in \@ref(eq:tbeta), that is:
\[\tilde\beta^{(b)}_\alpha = \hat \beta^{(b)}_{\hat\tau^{(b)}(\alpha)} - \frac{\hat\tau^{(b)}(\alpha)}{\big(1-2\hat\tau^{(b)}(\alpha)\big)\alpha}\cdot \left(\hat\beta_{0.5} -\hat \beta_{\hat\tau^{(b)}(\alpha)}\right).\]
Based on the resulting bootstrap distribution of $\left\{\tilde\beta^{(b)}_\alpha\right\}_{b=1}^B$ we, then, construct the confidence intervals.

```{r, echo=FALSE}
## bootstrapping the confidence intervals (runs long)
#
# bootstrap preparation

#params
which_ones = (1:lcoef)
target_alphas<-c(0.01,0.05,0.1)
#formul<-as.formula("r_.ab.~ turnover1 +pre_ean+ean+post_ean+news+log(Size)+ btm1  + I(turnover1*days_ean)+ I((btm1<1)*post_ean) +I(surprise*100) + LM.TONE + HIV4.TONE + ML.TONE+ Sector+Ticker")


#boot size
B<-100


#tau(alpha) placeholder
tau_alpha_b<-matrix(NA,nrow(tau_alpha),B)
rownames(tau_alpha_b)<-tau_alpha[,1]

tbeta<-list(matrix(NA,length(which_ones),B),
            matrix(NA,length(which_ones),B),
            matrix(NA,length(which_ones),B)
            )
Fess<-NULL
```


```{r, echo=FALSE}
for(bb in seq(1,1000,100)){
#for(bb in seq(1000,2000,100)){
  BB=bb+99
  print(bb)
  for (b in 1:B){
    #print(b)
    set.seed(123+bb+b)
    ############bootstrap
    #T
    bootT<-sample.int(length(blocksT),replace=T)
    dataBoot<-NULL
    for(i in bootT){
      dataBoot<-rbind(dataBoot,data[data$Date%in%blocksT[[i]],])
    }
    #N
    indiv<-individs[sample.int(length(individs),replace=T)]
    dataBootTN<-NULL
    for(i in 1:length(indiv)){
      dataBootTN<-rbind(dataBootTN,dataBoot[dataBoot$Ticker==indiv[i],])
    }
    dataBootTN<-data.frame(dataBootTN)

    ###############estimate tau(alpha)
    ind_use<-which(!is.na(dataBootTN$btm1))
    mod_b<-fit_eeffects(formul=formul,dat=dataBootTN[ind_use,],taus=tau_alpha[,1],ses=F)
    e_taus_f<-unlist(lapply(mod_b$mods,fitted)); e_taus_f<-matrix(e_taus_f,,length(mod_b$mods))

    Fess<-rbind(Fess,apply(e_taus_f,2,function(q,x){sum(x<q)},x=dataBootTN$r_.ab.[ind_use])/length(dataBootTN$r_.ab.[ind_use]))

    tau_alpha_b[,b]<-apply(e_taus_f,2,function(q,x){sum(x<q)},
                           x=dataBootTN$r_.ab.[ind_use])/length(dataBootTN$r_.ab.[ind_use])
    #linear interpolation
    tau_new_b = approx(tau_alpha_b[,b], tau_alpha[,1], xout=target_alphas)[[2]]

    ##############re-estimate the model for the target taus
    mod_b<-fit_eeffects(formul=formul,dat=dataBootTN[ind_use,],taus=c(tau_new_b,0.5),ses=F)
    coefsBoot<-mod_b$coefs[which_ones,]

    #compute ES coefs
    for(j in 1:length(target_alphas)){
      tbeta[[j]][,b]<-coefsBoot[which_ones,j] -
        tau_new_b[j]/((1-2*tau_new_b[j])*target_alphas[j])*(coefsBoot[which_ones,ncol(coefsBoot)]-coefsBoot[which_ones,j])
    }
  }
  save(tau_alpha_b,file=paste0("tau_alpha_b_",bb,"_",BB,".RData"))
  save(tbeta,file=paste0("tbeta",bb,"_",BB,".RData"))
}

```




```{r, echo=FALSE}

tau_alpha_b_all<-NULL
for(i in seq(1,901,100)){
  load(paste0("tau_alpha_b_",i,"_",i+99,".RData"))
  tau_alpha_b_all<-cbind(tau_alpha_b_all,tau_alpha_b)

}
tau_alpha_b<-tau_alpha_b_all
save(file="tau_alpha_b.RData",tau_alpha_b)

load(paste0("tbeta",1,"_",100,".RData"))
tbeta_all<-tbeta
for(i in seq(101,901,100)){
  load(paste0("tbeta",i,"_",i+99,".RData"))
  tbeta_all[[1]]<-cbind(tbeta_all[[1]],tbeta[[1]])
  tbeta_all[[2]]<-cbind(tbeta_all[[2]],tbeta[[2]])
  tbeta_all[[3]]<-cbind(tbeta_all[[3]],tbeta[[3]])

}
tbeta<-tbeta_all
save(file="tbeta.RData",tbeta)


#load("tau_alpha_b.RData")
#load("tbeta.RData")

```


```{r, figure5, fig.cap="The estimated relation between the expectile level $\\tau$ (vertical axis) and the quantile level $\\alpha$ (horizontal axis) using the original NASDAQ return data (solid line) with boostrap based mean and $95\\%$ confidence intervals (dashed lines).", echo=FALSE}
library(scales)
plot(tau_alpha[,2], tau_alpha[,1],type="l",col=NA, ylab=bquote(tau), xlab=bquote(alpha), axes=F, ylim=c(0,0.11), xlim=c(0,0.15))

axis(1, at=c(0,0.01,0.05,0.1,0.15), labels=c(0,0.01,0.05,0.1,0.15))
axis(2, las=1, at=c(0,0.05,0.1), labels=c(0,0.05,0.1))
par(xpd=T)

lines(tau_alpha[,2], tau_alpha[,1], lwd=2,col=alpha("gray44",0.7))
lines(apply(tau_alpha_b,1,mean), rownames(tau_alpha_b), col=1,lwd=2,lty=2)
lines(apply(tau_alpha_b,1,quantile,0.025), rownames(tau_alpha_b),lty=2,lwd=1)
lines(apply(tau_alpha_b,1,quantile,0.975), rownames(tau_alpha_b),lty=2,lwd=1)

```


```{r, echo=FALSE}
#compute 95% ci
tbeta_m<-tbeta_h<-tbeta_l<-tbeta_h1<-tbeta_l1<-tbeta_h2<-tbeta_l2<-NULL
levels<-c(0.001,0.01,0.05)
for(i in 1:length(tbeta)){
  tbeta_m<-cbind(tbeta_m, apply(tbeta[[i]],1,mean))
  tbeta_h<-cbind(tbeta_h, apply(tbeta[[i]],1,quantile, 1-levels[1]/2))
  tbeta_l<-cbind(tbeta_l, apply(tbeta[[i]],1,quantile, levels[1]/2))
  tbeta_h1<-cbind(tbeta_h1, apply(tbeta[[i]],1,quantile, 1-levels[2]/2))
  tbeta_l1<-cbind(tbeta_l1, apply(tbeta[[i]],1,quantile, levels[2]/2))
  tbeta_h2<-cbind(tbeta_h2, apply(tbeta[[i]],1,quantile, 1-levels[3]/2))
  tbeta_l2<-cbind(tbeta_l2, apply(tbeta[[i]],1,quantile, levels[3]/2))
}
```


```{r, echo=FALSE}
#table with the estimates
options(scipen=999)
which_ones=(1:(lcoef-1))
# tab<-cbind(paste0(round(tbeta[[1]][which_ones],4)," (",round(tbeta_l[which_ones,1],4),",",round(tbeta_h[which_ones,1],4),")"),
#            paste(round(tbeta[[2]][which_ones],4)," (",round(tbeta_l[which_ones,2],4),",",round(tbeta_h[which_ones,2],4),")"),
#            paste(round(tbeta[[3]][which_ones],4)," (",round(tbeta_l[which_ones,3],4),",",round(tbeta_h[which_ones,3],4),")")
#           )

# tab<-cbind(paste0(round(tbeta[[1]][which_ones],4)),
#            paste(round(tbeta[[2]][which_ones],4)),
#            paste(round(tbeta[[3]][which_ones],4))    )

 tab<-cbind(paste0(round(tbeta_m[1:14,1],4)),
            paste(round(tbeta_m[1:14,2],4)),
            paste(round(tbeta_m[1:14,3],4))  
            )

ind_sign<-cbind((tbeta_h2[which_ones,1]>0&tbeta_l2[which_ones,1]>0)|(tbeta_h2[which_ones,1]<0&tbeta_l2[which_ones,1]<0),
                (tbeta_h2[which_ones,2]>0&tbeta_l2[which_ones,2]>0)|(tbeta_h2[which_ones,2]<0&tbeta_l2[which_ones,2]<0),
                (tbeta_h2[which_ones,3]>0&tbeta_l2[which_ones,3]>0)|(tbeta_h2[which_ones,3]<0&tbeta_l2[which_ones,3]<0))
tab[ind_sign]<-paste0(tab[ind_sign],"*") # paste signif coefs
ind_sign<-cbind((tbeta_h1[which_ones,1]>0&tbeta_l1[which_ones,1]>0)|(tbeta_h1[which_ones,1]<0&tbeta_l1[which_ones,1]<0),
                (tbeta_h1[which_ones,2]>0&tbeta_l1[which_ones,2]>0)|(tbeta_h1[which_ones,2]<0&tbeta_l1[which_ones,2]<0),
                (tbeta_h1[which_ones,3]>0&tbeta_l1[which_ones,3]>0)|(tbeta_h1[which_ones,3]<0&tbeta_l1[which_ones,3]<0))
tab[ind_sign]<-paste0(tab[ind_sign],"*") # paste signif coefs
ind_sign<-cbind((tbeta_h[which_ones,1]>0&tbeta_l[which_ones,1]>0)|(tbeta_h[which_ones,1]<0&tbeta_l[which_ones,1]<0),
                (tbeta_h[which_ones,2]>0&tbeta_l[which_ones,2]>0)|(tbeta_h[which_ones,2]<0&tbeta_l[which_ones,2]<0),
                (tbeta_h[which_ones,3]>0&tbeta_l[which_ones,3]>0)|(tbeta_h[which_ones,3]<0&tbeta_l[which_ones,3]<0))
tab[ind_sign]<-paste0(tab[ind_sign],"*") # paste signif coefs


colnames(tab)<-c("$ES_{0.01}$", "$ES_{0.05}$","$ES_{0.1}$")

rownames(tab)<-c("Constant","pre_ean_{i,t}","ean_{i,t}","post_ean_{i,t}",
                                 "news_{i,t}","news_sector_{i,t}",  "news_day_{i,t}", 
                                 "log(size_{i,t})","btm_{i,t-1}", "turn_{i,t-1}*days_ean_{i,t}",
                                 "(btm_{i,t-1}< 1)*post_ean_{i,t}","supr_{i,t}",
                                 "lm_tone_{i,t}", "hv_tone_{i,t}"
                          )
  # c("Constant","$pre\\_ean_{i,t}$","$ean_{i,t}$","$post\\_ean_{i,t}$",
  #                "$news_{i,t}$", "$news\\_sector_{i,t}$", "$news\\_day_{i,t}$",
  #                                          "$\\log(size_{i,t})$","$btm_{i,t-1}$", "$turn_{i,t-1}*days\\_ean_{i,t}$",
  #                "$(btm_{i,t-1}\\leq 1)*post\\_ean_{i,t}$", "surp_{i,t}",
  #                                           "$lm\\_tone_{i,t}$", "$hv\\_tone_{i,t}$")

caption<-"The estimated coefficients $\\tilde\\beta_\\alpha$ measuring the effects of investor opinion on the expected shortfall. '***', '**', and '*' indicate significance of 0.001, 0.01, and 0.05 respectively obtained based on boostrap confidence intervalls."

 knitr::kable(tab, align = "llll",
               col.names = colnames(tab),
               row.names = TRUE,
               #table.attr = "id=\"table1\"",
               digits = 5,
               caption = caption
  )

```

Based on our bootstrap procedure, we confirm significant effects of $pre\_ean$, $ean$, and $news$ on $ES_\alpha$ with $\alpha=0.01,0.05,0.1$. Besides that, turnover around earnings announcement days $turn\cdot days\_ean$ and text sentiment $hv_tone$ show significant impact on $ES_{0.05}$ and $ES_{0.1}$. 

As in the case of conditional expectile model, earnings announcements and shares turnover around earnings announcements exhibit significant negative effects on the conditional expected shortfall. Also, the reverse effects where positive estimated effect of $pre\_ean$ follows by a negative estimate for $ean$ and $news$ persists in the conditional expected shortfall which makes the variables risk management relevant. 

# Conclusion

We analyzed the distributional effects of the investor opinion on asset prices based on a panel of abnormal NASDAQ returns for the time period of April 2015 - August 2019. We adopted the information flow structure of @Su2021 where investor opinion comprises such channels as investor attention, perception and sentiment. The proxies for each of the channels based on  previous related studies acted as covariates in an expectile regression model introduced by @Newey1987 with excess return as response to assess the distributional effects beyond the conditional mean regression and without imposing any assumptions on the response distribution. The majority of the estimated effects depends on the expectile level or the "extremeness" $\tau$ in a nonlinear way and the associated estimates change sign when moving from the left to the right tail or vice versa of the conditional response distribution. A close up to different events (new releases and days around earnings announcements with positive and negative polarity), we observe a significant increase in dispersion as measured by interexpectile range on the event days with respect to the no-event case. Particularly interesting appears the skewness effect of news when measured with expectile skewness, since positive/ negative news induce significant left/right skewness of the distribution. One possible explanation for the skewness "mutation" can be the "market sideness" of @SARKAR2009. Moreover, analogous significant effects are found in the conditional expected shortfall model, which we obtaine by plugging in our conditional expectile formulation in the expected-shortfall-expectile relation derived by @Taylor2008. Our findings therefore have important implications for risk management assessment of the investor opinion formation channels.

A direction of possible further research would be to extend investor sentiment to topics based representation and assess the effect of different news topics on the conditional distribution and on the conditional expected shortfall of stock returns.

# References

<div id="refs"></div>


# Appendix [-]

## List of the firm tickers in the dataset

The ticker list for the dataset is:
'AAPL', 'AMZN', 'TSLA', 'FB', 'BA', 'NFLX', 'DIS', 'EFX', 'BAC', 'INTC', 'F', 'GE', 'GM', 
 'MSFT', 'SBUX', 'AIR', 'AAL', 'IBM', 'JPM', 'CMG', 'WFC', 'C', 'TWTR', 'WMT', 'MCD', 'AMD', 'NVDA', 'JNJ', 'GS', 
 'BABA', 'CAT', 'MU', 'CSCO', 'XOM', 'CVX', 'BP', 'GOOGL', 'GPRO', 'COST', 'HD', 'NKE', 'KO', 
 'AXP', 'TGT', 'ATVI', 'CMCSA', 'DAL', 'LMT', 'T', 'ABBV', 'PFE', 'GILD', 'ADBE', 'CRM', 'VZ', 'AVGO', 'BX', 
 'LULU', 'BLK', 'UNH', 'KMI', 'BBY', 'PG', 'AGI', 'AMAT', 'MRK', 'M', 'BIDU', 'QCOM', 'FDX', 'AMGN', 
 'BMY', 'ORCL', 'BHP', 'MA', 'KR', 'MO', 'GME', 'PM', 'CHK', 'MMM', 'BBBY', 'COP', 'IRBT', 'MS', 
 'FCX', 'HAL', 'HPQ', 'UAL','JWN', 'CVS', 'V', 'EA', 'STZ', 'GLW', 'ADP', 'AZN', 'EBAY', 'ACN', 'PEP'. 

## News article data

In total, we have 30,424 news articles, and the average word count of the final news article sample is 1,114. 

```{r table00,echo=FALSE}
library(knitr)
library(kableExtra)
options(scipen=999)
text_decr<-data.frame(Year=c(seq(2015,2019),"All years"), News=c("4,395","5,391","5,738","8,465","6,435","30,424"),
                      Words=c("823","840","923","1,352","1,401","1,114"))
 knitr::kable(text_decr, align = "llll",
               col.names = c("Year","News Articles (merged)","Average Word Count"),
               row.names = FALSE,
               digits = 0,
               caption = "Description of the final textual corpus"
  )
```

## Empirical data summary

We provide a standard summary of data for each variable in Table \@ref(tab:table01) and Table \@ref(tab:table02), a time period and sector wise expectile summaries of the return distributions in Table \@ref(tab:table03) and Table \@ref(tab:table04), and per-expectile summary of explanatory variables to give the reader an overview of the data structure in Table \@ref(tab:table05).

```{r, echo=FALSE}
vars<-c("r_.ab.","log.SIZE.","BTM","TURNOVER")
library(moments)
mysummary<-function(x){
  x<-x[!is.na(x)]
  return(c(min(x),max(x),mean(x),sd(x),skewness(x)))#, kurtosis(x)))
}
```

```{r table01, echo=FALSE}
library(knitr)
options(scipen=999)
tab<-apply(data[,vars], 2,mysummary)
rownames(tab)<-c("min","max","mean","sd","skewness")#,"kurtosis")
colnames(tab)<-c("$r_{\\cdot,\\cdot}$","$\\log(size_{\\cdot,\\cdot})$","$btm_{\\cdot,\\cdot}$", "$turn_{\\cdot,\\cdot}$")
caption<-"Summary statistics for the variables: daily firm excess returns $r$, the logarithm of firm size $\\log(size)$, firm btm ratio $btm$, and shares turnover $turn$."

 knitr::kable(tab, align = "llll",
               col.names = colnames(tab),
               row.names = TRUE,
               digits = 5,
               caption = caption
  )
```


```{r table02,echo=FALSE}
vars_c<-c("surprise","eps","LM.TONE","HIV4.TONE")#,"ML.TONE")
tab<-cbind(apply(data[data$ean>0,vars_c[1],drop=F]*100,2,mysummary),apply(data[data$ean>0,vars_c[2],drop=F],2,mysummary),apply(data[data$news>0,vars_c[3:4]],2,mysummary))
rownames(tab)<-c("min","max","mean","sd","skewness")#,"kurtosis")
colnames(tab)<-c("$supr$", "$eps$", "$lm\\_tone$", "$hv\\_tone$")
caption<-"Summary statistics for the variables: earning surprise $supr$ only for the days of earnings announecements, news sentiment based on LM dictionary denoted as $lm\\_tone$, on HV dictionary denoted as $hv\\_tone$, and news sentiment based on machine learning denoted as $ml\\_tone$ only for the days of news releases."

 knitr::kable(tab, align = "llll",
               col.names = colnames(tab),
               row.names = TRUE,
               digits = 5,
               caption = caption
  )
```


In Table \@ref(tab:table03) empirical return expectiles $\hat e_{\tau}$ for $\tau = 0.05,0.25,0.5,0.75,$ and $0.95$ and different sub periods of the considered time span are reported. We observe that the tail indices remain approximately the same over time.

```{r table03, echo=FALSE}
library(expectreg,quietly =T,verbose=F)
taus=c(0.05,0.25,0.5,0.75,0.95)

expectile_taus<-function(x,taus){
  return(sapply(taus,FUN=expectile,x=x))
}

#expectiles
tab<-rbind(expectile_taus(data$r_.ab.,taus),
           expectile_taus(data$r_.ab.[data$Year%in% c("2015","2016")],taus),
           expectile_taus(data$r_.ab.[data$Year%in% c("2017", "2018", "2019")],taus)                                       )



rownames(tab)<-c("2015-2019",  "2015-2016", "2017-2019")
colnames(tab)<-paste0("$\\hat e_{",taus,"}$")
caption<-"Empirical expectiles for the excess returns for the whole time span 2015-2019, for the first sub period 2015-2016 and for the second sub period 2017-2019."

 knitr::kable(tab, align = "lll",
               col.names = colnames(tab),
               row.names = TRUE,
               digits = 5,
               caption = caption
  )
```
In Table \@ref(tab:table04) we report the empirical return expectiles $\hat e_{\tau}$ for $\tau = 0.05,0.25,0.5,0.75,$ and $0.95$ sector wise.



```{r table04, echo=FALSE}

#expectiles
exps<-expectile(data$r_.ab.,probs=taus)

tab<-cbind(aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[1]),
           aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[2])[,2],
aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[3])[,2],
aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[4])[,2],
aggregate(r_.ab.~Sector,data=data,FUN=expectile,probs=taus[5])[,2])



colnames(tab)[-1]<-paste0("$\\hat e_{",taus,"}$")
caption<-"Empirical expectiles for the excess returns for the whole time span 2015-2019 for each of the ten sectors"

 knitr::kable(tab, align = "lll",
               col.names = colnames(tab),
               row.names = TRUE,
               digits = 5,
               caption = caption
  )
```

Here we observe substantial variation of empirical expectiles between sectors. Based on this observation, we include sector and firm dummies to account for the posible individual variability and the variability across sectors.

In the following Table \@ref(tab:table05) per-expectile distributional summary is displayed. The summary statistics for the explanatory variables is conditioned on excess returns belonging to a specific empirical expectile interval: $[\min(r), \hat e_{0.05})$, $[\hat e_{0.05}, \hat e_{0.25} )$,  $[\hat e_{0.25}, \hat e_{0.5})$,  $[\hat e_{0.5}, \hat e_{0.75})$, $[\hat e_{0.75}, \hat e_{0.95})$, and $[\hat e_{0.95}, \max(r)]$. We report the mean and the standard deviation in parenthesis for the variables.

```{r table05,echo=FALSE}

lbls<-c(paste("$r\\leq \\hat e_{",taus[1],"}$"),
        paste("$\\hat e_{",taus[1:(length(taus)-1)],"}\\leq r\\leq \\hat e_{",taus[-1],"}$"),paste("$r\\geq \\hat e_{",taus[length(taus)],"}$"))

data$crab<-cut(data$r_.ab.,breaks=c(-Inf,exps,+Inf),labels=lbls)

mysummary2<-function(x){
  return(paste0(round(mean(x),4)," (",round(sd(x),4),") "))
}

mysummary3<-function(x){
  return(paste0(round(mean(x[x>0]),4)," (",round(sd(x[x>0]),4),") "))
}


tab<-cbind(aggregate(turnover1~crab,data=data,FUN=mysummary2)[,2],
           aggregate(log.SIZE.~crab,data=data,FUN=mysummary2)[,2],
           aggregate(btm1~crab,data=data,FUN=mysummary2)[,2],
           aggregate(news~crab,data=data,FUN=mysummary2)[,2],
           aggregate(ean~crab,data=data,FUN=mysummary2)[,2],
           aggregate(eps~crab,data=data,FUN=mysummary3)[,2]
           )

colnames(tab)<-c("turn","log(size)", "btm","news", "ean", "eps")
caption<-"Per-expectile means (standard deviations) of the variables shares turnover $turn$, logarithm of size $\\log(size)$, btm ratios $btm$, indicator of news arrivals $news$, indicator of earnings announcements $ean$, and earning per share $eps$."
rownames(tab)<-lbls

 knitr::kable(tab, align = "lll",
               col.names = colnames(tab),
               row.names = TRUE,
               digits = 5,
               caption = caption
  )

```

Interestingly, the extreme return states $r\leq \hat e_{0.05}$ and $r\geq \hat e_{0.95}$ are associated with substantially higher mean turnover and earnings announcements rate, slightly lower mean size and with somewhat higher mean btm ratios and news arrivals rate.

Based on the data description above, one expects possibly different effects of the considered covariates on the location, scale and shape of the conditional return distribution. As in the summaries above, it is possible to represent the conditional return distribution through its conditional expectiles. A practical estimator of the heterogeneous effects over the return distribution can be obtained by expectile regression.
